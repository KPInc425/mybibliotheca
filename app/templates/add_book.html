{% extends "base.html" %}
{% block title %}Add Book - MyBibliotheca{% endblock %}
{% block content %}

<style>
  :root {
    --primary-brown: #8B4513;
    --light-brown: #D2B48C;
    --cream: #F5F5DC;
    --warm-white: #FEFEFE;
    --gold: #DAA520;
    --shadow: rgba(0,0,0,0.1);
    --hover-shadow: rgba(0,0,0,0.2);
  }

  .library-header {
    background: linear-gradient(135deg, var(--primary-brown) 0%, var(--light-brown) 100%);
    color: white;
    padding: 2rem;
    margin-bottom: 2rem;
    border-radius: 15px;
    text-align: center;
    position: relative;
    overflow: hidden;
  }

  .library-header::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: url('https://www.transparenttextures.com/patterns/paper-fibers.png');
    opacity: 0.3;
  }

  .library-header h1 {
    font-size: 2.5rem;
    font-weight: 700;
    margin: 0;
    text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
    position: relative;
    z-index: 1;
  }

  .form-container {
    background: var(--cream);
    border-radius: 20px;
    padding: 2rem;
    box-shadow: 0 8px 25px var(--shadow);
    border: 3px solid var(--light-brown);
  }

  .scanner-section {
    background: var(--warm-white);
    border: 2px solid var(--light-brown);
    border-radius: 15px;
    padding: 1.5rem;
    margin-bottom: 2rem;
    text-align: center;
  }

  .scanner-buttons {
    display: flex;
    gap: 1rem;
    justify-content: center;
    margin-bottom: 1rem;
  }

  .btn-scan {
    background: linear-gradient(135deg, var(--primary-brown), var(--light-brown));
    border: none;
    color: white;
    padding: 0.75rem 1.5rem;
    border-radius: 10px;
    font-weight: 600;
    transition: all 0.3s ease;
    box-shadow: 0 4px 15px rgba(139, 69, 19, 0.3);
  }

  .btn-scan:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(139, 69, 19, 0.4);
    color: white;
  }

  .btn-stop {
    background: linear-gradient(135deg, #dc3545, #c82333);
    border: none;
    color: white;
    padding: 0.75rem 1.5rem;
    border-radius: 10px;
    font-weight: 600;
    transition: all 0.3s ease;
    box-shadow: 0 4px 15px rgba(220, 53, 69, 0.3);
  }

  .btn-stop:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(220, 53, 69, 0.4);
    color: white;
  }

  #scanner {
    border: 3px solid var(--primary-brown) !important;
    border-radius: 15px !important;
    margin: 1rem auto !important;
    box-shadow: 0 8px 25px var(--shadow) !important;
    position: relative;
    overflow: hidden;
    cursor: pointer;
  }

  #scanner-overlay {
    border: 3px solid var(--gold) !important;
    box-shadow: 0 0 20px rgba(218, 165, 32, 0.6);
    animation: pulse 2s infinite;
  }

  @keyframes pulse {
    0% { box-shadow: 0 0 20px rgba(218, 165, 32, 0.6); }
    50% { box-shadow: 0 0 30px rgba(218, 165, 32, 0.8); }
    100% { box-shadow: 0 0 20px rgba(218, 165, 32, 0.6); }
  }

  .form-group {
    margin-bottom: 1.5rem;
  }

  .form-group label {
    display: block;
    font-weight: 600;
    color: var(--primary-brown);
    margin-bottom: 0.5rem;
    font-size: 1.1rem;
  }

  .form-control {
    width: 100%;
    padding: 0.75rem 1rem;
    border: 2px solid var(--light-brown);
    border-radius: 10px;
    font-size: 1rem;
    transition: all 0.3s ease;
    background: var(--warm-white);
  }

  .form-control:focus {
    outline: none;
    border-color: var(--gold);
    box-shadow: 0 0 15px rgba(218, 165, 32, 0.3);
  }

  .btn-fetch {
    background: linear-gradient(135deg, var(--gold), #B8860B);
    border: none;
    color: white;
    padding: 0.75rem 2rem;
    border-radius: 10px;
    font-weight: 600;
    transition: all 0.3s ease;
    box-shadow: 0 4px 15px rgba(218, 165, 32, 0.3);
    margin-bottom: 1.5rem;
  }

  .btn-fetch:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(218, 165, 32, 0.4);
    color: white;
  }

  .book-cover-preview {
    text-align: center;
    margin: 2rem 0;
    padding: 1.5rem;
    background: var(--warm-white);
    border: 2px solid var(--light-brown);
    border-radius: 15px;
  }

  .book-cover-preview img {
    max-height: 200px;
    border-radius: 10px;
    box-shadow: 0 8px 25px var(--shadow);
  }

  .checkbox-group {
    display: flex;
    flex-direction: column;
    gap: 1rem;
    margin: 2rem 0;
    background: var(--warm-white);
    padding: 1.5rem;
    border-radius: 15px;
    border: 2px solid var(--light-brown);
  }

  .checkbox-item {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    font-size: 1.1rem;
    color: var(--primary-brown);
    font-weight: 500;
  }

  .checkbox-item input[type="checkbox"] {
    width: 20px;
    height: 20px;
    accent-color: var(--primary-brown);
  }

  .btn-submit {
    background: linear-gradient(135deg, var(--primary-brown), var(--light-brown));
    border: none;
    color: white;
    padding: 1rem 3rem;
    border-radius: 15px;
    font-weight: 700;
    font-size: 1.2rem;
    transition: all 0.3s ease;
    box-shadow: 0 6px 20px rgba(139, 69, 19, 0.3);
    width: 100%;
    margin: 2rem 0 1rem 0;
  }

  .btn-submit:hover {
    transform: translateY(-3px);
    box-shadow: 0 8px 25px rgba(139, 69, 19, 0.4);
    color: white;
  }

  .back-link {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    color: var(--primary-brown);
    text-decoration: none;
    font-weight: 600;
    padding: 0.75rem 1.5rem;
    border: 2px solid var(--light-brown);
    border-radius: 10px;
    transition: all 0.3s ease;
    background: var(--warm-white);
  }

  .back-link:hover {
    background: var(--light-brown);
    color: white;
    transform: translateX(-5px);
  }

  .row {
    display: flex;
    gap: 1rem;
    flex-wrap: wrap;
  }

  .col-md-6 {
    flex: 1;
    min-width: 250px;
  }

  @media (max-width: 768px) {
    .scanner-buttons {
      flex-direction: column;
      align-items: center;
    }
    
    .row {
      flex-direction: column;
    }
    
    .library-header h1 {
      font-size: 2rem;
    }
    
    #scanner {
      height: 350px !important;
      max-width: 100% !important;
      margin: 1rem 0 !important;
    }
    
    .btn-scan, .btn-stop, .btn-fetch {
      min-height: 44px;
      min-width: 44px;
      font-size: 1rem;
    }
    
    /* Better mobile scanner positioning */
    #scanner-overlay {
      width: 90% !important;
      height: 50% !important;
    }
  }

  /* Floating Notification System */
  .floating-notification {
    position: fixed;
    top: 20px;
    right: 20px;
    padding: 12px 20px;
    border-radius: 8px;
    color: white;
    font-weight: 600;
    z-index: 9999;
    transform: translateX(100%);
    transition: transform 0.3s ease;
    box-shadow: 0 4px 12px rgba(0,0,0,0.3);
  }

  .floating-notification.show {
    transform: translateX(0);
  }

  .floating-notification.success {
    background: linear-gradient(135deg, #28a745, #20c997);
  }

  .floating-notification.error {
    background: linear-gradient(135deg, #dc3545, #c82333);
  }

  .floating-notification.warning {
    background: linear-gradient(135deg, #ffc107, #e0a800);
    color: #212529;
  }

  .floating-notification.info {
    background: linear-gradient(135deg, #17a2b8, #138496);
  }

  @media (max-width: 768px) {
  }
</style>

<div class="library-header">
  <h1>üìö Add New Book</h1>
  <p class="mb-0">Scan, search, or manually add books to your library</p>
</div>

<!-- Floating Notification Container -->
<div id="notification-container"></div>

<div class="form-container">
  <form method="post">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
    
    <!-- Scanner Section -->
    <div class="scanner-section">
      <h4 style="color: var(--primary-brown); margin-bottom: 1rem;">üì± Barcode Scanner</h4>
      
      <div class="scanner-buttons">
        <button type="button" class="btn-scan" onclick="toggleScanner()" id="scannerBtn">
          üì∑ Scan Barcode
        </button>
      </div>
      
      <!-- Scanner viewport -->
      <div id="scanner" style="
        width: 100%;
        max-width: 400px;
        height: 225px;
        display: none;
        margin: 1rem auto;
        overflow: hidden;
        position: relative;
        background-color: #000;
        border-radius: 15px;
        cursor: pointer;
      ">
        <!-- Video element required by ZXing -->
        <video id="scanner-video" style="
          width: 100%;
          height: 100%;
          object-fit: cover;
          border-radius: 15px;
        "></video>
        
        <div id="scanner-overlay" style="
          position: absolute;
          top: 50%;
          left: 50%;
          transform: translate(-50%, -50%);
          width: 80%;
          height: 60%;
          z-index: 10;
          pointer-events: none;
          border: 2px solid var(--gold);
          border-radius: 10px;
        ">
          <!-- Distance guide lines for close-up scanning -->
          <div id="distance-guide" style="
            position: absolute;
            top: -20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.6);
            color: rgba(255,255,255,0.8);
            padding: 2px 6px;
            border-radius: 8px;
            font-size: 9px;
            white-space: nowrap;
            opacity: 0.8;
            transition: opacity 0.5s ease;
          ">üìè 5-10cm</div>
          
          <!-- Corner guides for better positioning -->
          <div style="
            position: absolute;
            top: 5px;
            left: 5px;
            width: 20px;
            height: 20px;
            border-top: 2px solid var(--gold);
            border-left: 2px solid var(--gold);
          "></div>
          <div style="
            position: absolute;
            top: 5px;
            right: 5px;
            width: 20px;
            height: 20px;
            border-top: 2px solid var(--gold);
            border-right: 2px solid var(--gold);
          "></div>
          <div style="
            position: absolute;
            bottom: 5px;
            left: 5px;
            width: 20px;
            height: 20px;
            border-bottom: 2px solid var(--gold);
            border-left: 2px solid var(--gold);
          "></div>
          <div style="
            position: absolute;
            bottom: 5px;
            right: 5px;
            width: 20px;
            height: 20px;
            border-bottom: 2px solid var(--gold);
            border-right: 2px solid var(--gold);
          "></div>
          
          <!-- Detection progress indicator -->
          <div id="detection-progress" style="
            position: absolute;
            bottom: -30px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 12px;
            display: none;
          "></div>
        </div>
      </div>
    </div>

    <!-- ISBN and Fetch Section -->
    <div class="form-group">
      <label for="isbn">üìñ ISBN Number</label>
      <input id="isbn" name="isbn" class="form-control" value="{{ request.form.isbn or '' }}" 
             type="text" pattern="[0-9\-]+" title="Enter a valid ISBN (digits and hyphens only)"
             placeholder="Enter ISBN or scan barcode above">
      <button name="fetch" value="1" type="submit" class="btn-fetch mt-2">
        üîç Fetch Book Data
      </button>
    </div>

    <!-- Book Details -->
    <div class="row">
      <div class="col-md-6">
        <div class="form-group">
          <label for="title">üìö Title</label>
          <input id="title" name="title" class="form-control" 
                 value="{{ book_data.title if book_data else request.form.title or '' }}"
                 placeholder="Enter book title">
        </div>
      </div>
      <div class="col-md-6">
        <div class="form-group">
          <label for="author">‚úçÔ∏è Author</label>
          <input name="author" class="form-control" 
                 value="{{ book_data.author if book_data else request.form.author or '' }}"
                 placeholder="Enter author name">
        </div>
      </div>
    </div>

    <div class="row">
      <div class="col-md-6">
        <div class="form-group">
          <label for="start_date">üìÖ Start Date</label>
          <input name="start_date" type="date" class="form-control">
        </div>
      </div>
      <div class="col-md-6">
        <div class="form-group">
          <label for="finish_date">üèÅ Finish Date</label>
          <input name="finish_date" type="date" class="form-control">
        </div>
      </div>
    </div>

    <!-- Book Cover Preview -->
    {% if book_data and book_data.cover %}
    <div class="book-cover-preview">
      <h5 style="color: var(--primary-brown); margin-bottom: 1rem;">üì∏ Book Cover</h5>
      <img src="{{ book_data.cover }}" alt="Book Cover" class="img-fluid">
    </div>
    {% endif %}

    <!-- Options -->
    <div class="checkbox-group">
      <h5 style="color: var(--primary-brown); margin-bottom: 1rem;">‚öôÔ∏è Reading Options</h5>
      <label class="checkbox-item">
        <input type="checkbox" name="want_to_read" {% if request.form.want_to_read %}checked{% endif %}>
        <span>üìã Want to Read (Add to reading list)</span>
      </label>
      <label class="checkbox-item">
        <input type="checkbox" name="library_only" {% if request.form.library_only %}checked{% endif %}>
        <span>üìö Library Only (Reference/Collection)</span>
      </label>
    </div>

    <!-- Submit Button -->
    <button type="submit" name="add" class="btn-submit">
      ‚ûï Add Book to Library
    </button>
  </form>

  <!-- Back Link -->
  <div style="text-align: center; margin-top: 1rem;">
    <a href="{{ url_for('main.index') }}" class="back-link">
      ‚¨ÖÔ∏è Back to Library
    </a>
  </div>
</div>

<!-- Native BarcodeDetector API (free, modern, mobile-optimized) -->
<script>
// Clear any potential cached references
if (typeof Quagga !== 'undefined') {
  console.log("Clearing old QuaggaJS references");
  delete window.Quagga;
}

if (typeof ZXing !== 'undefined') {
  console.log("Clearing old ZXing references");
  delete window.ZXing;
}

if (typeof Dynamsoft !== 'undefined') {
  console.log("Clearing old Dynamsoft references");
  delete window.Dynamsoft;
}

// Check if BarcodeDetector is supported
if (!('BarcodeDetector' in window)) {
  console.warn("BarcodeDetector not supported, falling back to manual camera handling");
  // We'll implement a fallback with manual camera handling
}

let scanner = null;
let lastScanTime = 0;
const SCAN_COOLDOWN = 2000;
let scanAttempts = 0;
const MAX_SCAN_ATTEMPTS = 10;
let videoStream = null;
let animationFrameId = null;
let lastDetectedCode = null;
let detectionCount = 0;
const REQUIRED_DETECTIONS = 3; // Require multiple consistent detections

// Global mobile detection
const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);

// Check if the detected format is likely to be an ISBN
function isLikelyISBNFormat(format) {
  // ISBNs are typically EAN-13, EAN-8, Code 128, or Code 39
  // BarcodeDetector API returns lowercase format names
  const isbnFormats = [
    'ean_13', 'ean_8', 'code_128', 'code_39',  // BarcodeDetector API formats
    'EAN_13', 'EAN_8', 'CODE_128', 'CODE_39',  // Legacy formats
    'EAN13', 'EAN8', 'CODE128', 'CODE39'       // Alternative formats
  ];
  return isbnFormats.includes(format);
}

// Enhanced validation - check both format and code structure
function isValidISBNCode(code, format) {
  const cleanCode = code.replace(/[-\s]/g, '');
  
  console.log("Validating ISBN:", cleanCode, "Format:", format);
  
  // First check format
  if (!isLikelyISBNFormat(format)) {
    console.log("Format not recognized as ISBN:", format);
    return false;
  }
  
  // Then check code structure
  if (cleanCode.length === 13) {
    // ISBN-13: must start with 978 or 979
    if (cleanCode.startsWith('978') || cleanCode.startsWith('979')) {
      console.log("Valid ISBN-13 detected:", cleanCode);
      return true;
    } else {
      console.log("Invalid ISBN-13 prefix:", cleanCode);
      return false;
    }
  } else if (cleanCode.length === 10) {
    // ISBN-10: 9 digits + 1 digit or X
    if (/^\d{9}[\dX]$/i.test(cleanCode)) {
      console.log("Valid ISBN-10 detected:", cleanCode);
      return true;
    } else {
      console.log("Invalid ISBN-10 format:", cleanCode);
      return false;
    }
  } else {
    console.log("Invalid length:", cleanCode.length);
    return false;
  }
}

// Floating notification system
function showNotification(message, type = 'info', duration = 3000) {
  const container = document.getElementById('notification-container');
  const notification = document.createElement('div');
  notification.className = `floating-notification ${type}`;
  notification.textContent = message;
  
  container.appendChild(notification);
  
  // Trigger animation
  setTimeout(() => {
    notification.classList.add('show');
  }, 10);
  
  // Remove notification
  setTimeout(() => {
    notification.classList.remove('show');
    setTimeout(() => {
      if (container.contains(notification)) {
        container.removeChild(notification);
      }
    }, 300);
  }, duration);
}

// Get the best camera for barcode scanning
async function getBestCamera() {
  try {
    const devices = await navigator.mediaDevices.enumerateDevices();
    const videoDevices = devices.filter(device => device.kind === 'videoinput');
    
    console.log("Available cameras:", videoDevices.map(d => d.label || d.deviceId));
    
    // First, filter for back-facing cameras only
    const backCameras = videoDevices.filter(device => {
      const label = device.label.toLowerCase();
      return label.includes('back') || label.includes('rear') || label.includes('environment');
    });
    
    console.log("Back-facing cameras:", backCameras.map(d => d.label || d.deviceId));
    
    if (backCameras.length === 0) {
      console.log("No back-facing cameras found, using first available camera");
      return videoDevices.length > 0 ? videoDevices[0].deviceId : undefined;
    }
    
    // Among back cameras, prefer the main camera (avoid wide-angle, ultra-wide, etc.)
    const mainBackCamera = backCameras.find(device => {
      const label = device.label.toLowerCase();
      // Avoid wide-angle, ultra-wide, or telephoto cameras
      return !label.includes('wide') && 
             !label.includes('ultra') && 
             !label.includes('telephoto') &&
             !label.includes('macro');
    });
    
    if (mainBackCamera) {
      console.log("Selected main back camera:", mainBackCamera.label || mainBackCamera.deviceId);
      return mainBackCamera.deviceId;
    }
    
    // Fallback to first back camera
    console.log("Using fallback back camera:", backCameras[0].label || backCameras[0].deviceId);
    return backCameras[0].deviceId;
  } catch (error) {
    console.error("Error enumerating cameras:", error);
    return undefined;
  }
}

// Get optimal camera constraints based on device
async function getCameraConstraints() {
  if (isMobile) {
    const bestCameraId = await getBestCamera();
    // Use advanced constraints for focus and zoom if supported
    return {
      video: {
        width: { min: 640, ideal: 1280, max: 1920 },
        height: { min: 480, ideal: 720, max: 1080 },
        facingMode: "environment",
        deviceId: bestCameraId ? { exact: bestCameraId } : undefined,
        frameRate: { ideal: 15, max: 30 },
        // Try advanced constraints for better close-up focus
        advanced: [
          { focusMode: 'continuous' },
          { zoom: 1.2 }
        ]
      }
    };
  } else {
    return {
      video: {
        width: { min: 640, ideal: 1280, max: 1920 },
        height: { min: 480, ideal: 720, max: 1080 },
        facingMode: "environment"
      }
    };
  }
}

function toggleScanner() {
  const scannerBtn = document.getElementById('scannerBtn');
  
  if (scanner) {
    // Scanner is running, stop it
    stopScanner();
    scannerBtn.textContent = 'üì∑ Scan Barcode';
    scannerBtn.className = 'btn-scan';
  } else {
    // Scanner is not running, start it
    startScanner();
  }
}

function startScanner() {
  const scannerDiv = document.getElementById('scanner');
  const scannerBtn = document.getElementById('scannerBtn');
  
  // Show loading state
  scannerBtn.disabled = true;
  scannerBtn.textContent = 'üîÑ Starting...';
  
  scannerDiv.style.display = 'block';

  if (scanner) {
    // Stop animation frame
    if (animationFrameId) {
      cancelAnimationFrame(animationFrameId);
      animationFrameId = null;
    }
    
    // Stop video stream
    if (videoStream) {
      videoStream.getTracks().forEach(track => track.stop());
      videoStream = null;
    }
    
    scanner = null;
  }

  // Reset scan attempts
  scanAttempts = 0;

  // Add timeout to prevent stuck state
  const timeoutId = setTimeout(() => {
    if (!scanner) {
      console.error("Scanner initialization timeout");
      showNotification('Scanner initialization timed out. Please try again.', 'error', 4000);
      resetScannerUI();
    }
  }, 15000); // 15 second timeout

  initializeBarcodeDetectorScanner();

  function initializeBarcodeDetectorScanner() {
    console.log("Initializing BarcodeDetector scanner...");
    
    // Get the video element
    const videoElement = document.getElementById('scanner-video');
    if (!videoElement) {
      console.error("Video element not found!");
      showNotification('Scanner error: Video element not found', 'error', 4000);
      resetScannerUI();
      return;
    }
    
    // Check if BarcodeDetector is supported
    if (!('BarcodeDetector' in window)) {
      console.error("BarcodeDetector not supported in this browser");
      showNotification('Barcode scanning not supported in this browser. Please use Chrome, Edge, or Safari.', 'error', 5000);
      resetScannerUI();
      return;
    }
    
    // Create BarcodeDetector instance with ISBN formats
    const barcodeDetector = new BarcodeDetector({
      formats: ['ean_13', 'ean_8', 'code_128', 'code_39']
    });
    
    // Get camera stream with simplified constraints to avoid conflicts
    getCameraConstraints().then(constraints => {
      navigator.mediaDevices.getUserMedia(constraints)
        .then(stream => {
          videoStream = stream;
          videoElement.srcObject = stream;
          
          // Wait for video to be ready
          return new Promise((resolve) => {
            videoElement.onloadedmetadata = () => {
              videoElement.play();
              resolve();
            };
          });
        })
        .then(() => {
          console.log("Camera stream started successfully");
          
          // Start continuous scanning with improved error handling
          function scanFrame() {
            if (!scanner) return; // Stop if scanner was stopped
            
            // Check if video element is ready for detection
            if (videoElement.readyState < 2) { // HAVE_CURRENT_DATA
              animationFrameId = requestAnimationFrame(scanFrame);
              return;
            }
            
            barcodeDetector.detect(videoElement)
              .then(barcodes => {
                if (barcodes.length > 0) {
                  const barcode = barcodes[0];
                  const now = Date.now();
                  
                  if (now - lastScanTime < SCAN_COOLDOWN) {
                    animationFrameId = requestAnimationFrame(scanFrame);
                    return;
                  }
                  
                  const code = barcode.rawValue;
                  const format = barcode.format;
                  
                  // Check if this is the same code as last detection
                  if (code === lastDetectedCode) {
                    detectionCount++;
                    console.log(`BarcodeDetector detected code: ${code} (detection ${detectionCount}/${REQUIRED_DETECTIONS})`);
                    
                    // Show progress indicator
                    const progressEl = document.getElementById('detection-progress');
                    if (progressEl) {
                      progressEl.style.display = 'block';
                      progressEl.textContent = `Detecting: ${detectionCount}/${REQUIRED_DETECTIONS}`;
                      progressEl.style.background = detectionCount >= REQUIRED_DETECTIONS ? 'rgba(40, 167, 69, 0.9)' : 'rgba(0,0,0,0.8)';
                    }
                  } else {
                    // New code detected, reset counter
                    lastDetectedCode = code;
                    detectionCount = 1;
                    console.log(`BarcodeDetector detected new code: ${code} (detection 1/${REQUIRED_DETECTIONS})`);
                    
                    // Show progress indicator
                    const progressEl = document.getElementById('detection-progress');
                    if (progressEl) {
                      progressEl.style.display = 'block';
                      progressEl.textContent = `Detecting: 1/${REQUIRED_DETECTIONS}`;
                      progressEl.style.background = 'rgba(0,0,0,0.8)';
                    }
                  }
                  
                  // Only proceed if we have enough consistent detections
                  if (detectionCount < REQUIRED_DETECTIONS) {
                    animationFrameId = requestAnimationFrame(scanFrame);
                    return;
                  }
                  
                  // Reset for next scan
                  lastDetectedCode = null;
                  detectionCount = 0;
                  
                  scanAttempts++;
                  
                  if (isValidISBNCode(code, format)) {
                    console.log("Valid ISBN detected:", code);
                    document.getElementById('isbn').value = code;
                    stopScanner();
                    lastScanTime = now;
                    
                    // Show success notification
                    showNotification(`ISBN detected: ${code}`, 'success', 2000);
                    
                    // Auto-fetch the book data
                    setTimeout(() => {
                      document.querySelector('button[name="fetch"]').click();
                    }, 500);
                  } else {
                    console.log("Invalid ISBN format:", code, format);
                    showNotification(`Invalid format: ${format}`, 'warning', 2000);
                    
                    // Stop after too many invalid attempts
                    if (scanAttempts >= MAX_SCAN_ATTEMPTS) {
                      stopScanner();
                      showNotification('Too many invalid scans. Please try again.', 'error', 3000);
                    }
                  }
                } else {
                  // No barcode detected, reset detection counter
                  if (lastDetectedCode) {
                    console.log("No barcode detected, resetting detection counter");
                    lastDetectedCode = null;
                    detectionCount = 0;
                    
                    // Hide progress indicator
                    const progressEl = document.getElementById('detection-progress');
                    if (progressEl) {
                      progressEl.style.display = 'none';
                    }
                  }
                }
                
                // Continue scanning
                if (scanner) {
                  animationFrameId = requestAnimationFrame(scanFrame);
                }
              })
              .catch(error => {
                console.log("Scanning error:", error);
                // Only log errors, don't stop scanning unless it's a critical error
                if (error.name === 'InvalidStateError') {
                  // Video element not ready, wait a bit before retrying
                  setTimeout(() => {
                    if (scanner) {
                      animationFrameId = requestAnimationFrame(scanFrame);
                    }
                  }, 100);
                } else {
                  // Continue scanning for other errors
                  if (scanner) {
                    animationFrameId = requestAnimationFrame(scanFrame);
                  }
                }
              });
          }
          
          // Start scanning
          scanner = barcodeDetector;
          scanFrame();
          
          // Set up mobile focus detection
          setupMobileFocusDetection();
          
          // Improved tap-to-focus for mobile devices
          videoElement.addEventListener('click', function(e) {
            if (videoStream) {
              const track = videoStream.getVideoTracks()[0];
              if (track && track.getCapabilities) {
                const capabilities = track.getCapabilities();
                // Try to set zoom and focus on tap
                let zoomSupported = capabilities.zoom !== undefined;
                let focusSupported = capabilities.focusMode && capabilities.focusMode.includes('manual');
                let zoomValue = 1.2;
                if (zoomSupported) {
                  let minZoom = capabilities.zoom.min || 1;
                  let maxZoom = capabilities.zoom.max || 2;
                  zoomValue = Math.min(Math.max(zoomValue, minZoom), maxZoom);
                }
                // Try to set both zoom and focus
                let constraints = {};
                if (zoomSupported) constraints.zoom = zoomValue;
                if (focusSupported) {
                  let min = capabilities.focusDistance?.min ?? 0;
                  constraints.focusMode = 'manual';
                  constraints.focusDistance = min;
                }
                if (Object.keys(constraints).length > 0) {
                  track.applyConstraints(constraints).then(() => {
                    showNotification('üîç Tap-to-focus and zoom applied', 'info', 1200);
                  }).catch(() => {
                    // Fallback to continuous focus
                    track.applyConstraints({ focusMode: 'continuous' }).then(() => {
                      showNotification('üîç Fallback to auto-focus', 'info', 1200);
                    });
                  });
                } else {
                  showNotification('üì± Hold steady for best results', 'info', 1000);
                }
              }
            }
          });
          
          // Add visual indicator for tap-to-focus
          videoElement.style.cursor = 'pointer';
          videoElement.title = 'Tap to focus for close-up scanning';
          
          // Add focus status indicator
          const focusIndicator = document.createElement('div');
          focusIndicator.id = 'focus-indicator';
          focusIndicator.style.cssText = `
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 5px 8px;
            border-radius: 15px;
            font-size: 10px;
            z-index: 20;
            pointer-events: none;
            transition: all 0.3s ease;
          `;
          focusIndicator.textContent = 'üîç Tap to focus';
          focusIndicator.title = 'Tap the video to trigger auto-focus';
          scannerDiv.appendChild(focusIndicator);
          
          clearTimeout(timeoutId);
          
          console.log("BarcodeDetector scanner initialized successfully");
          
          // Update button state
          scannerBtn.disabled = false;
          scannerBtn.textContent = '‚èπÔ∏è Stop Scanner';
          scannerBtn.className = 'btn-stop';
          
          // Show success notification
          showNotification('Scanner ready! Point camera at barcode', 'success', 3000);
          
          // Show close-up scanning instructions
          setTimeout(() => {
            showNotification('üí° For best results: Ensure good lighting, hold barcode 5‚Äì10cm from camera, tap to focus, and try moving barcode slowly closer/farther.', 'info', 6000);
          }, 3500);
          
          // Fade out distance guide after 3 seconds
          setTimeout(() => {
            const distanceGuide = document.getElementById('distance-guide');
            if (distanceGuide) {
              distanceGuide.style.opacity = '0.2';
            }
          }, 3000);
        })
        .catch((err) => {
          clearTimeout(timeoutId);
          console.error("BarcodeDetector scanner init error:", err);
          
          let errorMessage = "Error starting scanner: ";
          if (err.name === 'NotAllowedError') {
            errorMessage += "Camera access denied. Please allow camera permissions.";
            showNotification(errorMessage, 'error', 5000);
            resetScannerUI();
          } else if (err.name === 'NotFoundError') {
            errorMessage += "No camera found on this device.";
            showNotification(errorMessage, 'error', 5000);
            resetScannerUI();
          } else if (err.name === 'NotReadableError') {
            errorMessage += "Camera is already in use by another application.";
            showNotification(errorMessage, 'error', 5000);
            resetScannerUI();
          } else if (err.name === 'OverconstrainedError') {
            console.log("Camera constraints not supported, trying minimal constraints...");
            showNotification('Trying alternative camera settings...', 'info', 2000);
            
            // Try with minimal constraints as fallback
            navigator.mediaDevices.getUserMedia({
              video: { facingMode: "environment" }
            }).then(stream => {
              videoStream = stream;
              videoElement.srcObject = stream;
              return new Promise((resolve) => {
                videoElement.onloadedmetadata = () => {
                  videoElement.play();
                  resolve();
                };
              });
            }).then(() => {
              console.log("Camera started with minimal constraints");
              
              // Start scanning with minimal setup
              scanner = barcodeDetector;
              
              // Set up mobile focus detection for minimal mode
              setupMobileFocusDetection();
              
              function scanFrameMinimal() {
                if (!scanner) return;
                
                if (videoElement.readyState < 2) {
                  animationFrameId = requestAnimationFrame(scanFrameMinimal);
                  return;
                }
                
                barcodeDetector.detect(videoElement)
                  .then(barcodes => {
                    if (barcodes.length > 0) {
                      const barcode = barcodes[0];
                      const now = Date.now();
                      
                      if (now - lastScanTime < SCAN_COOLDOWN) {
                        animationFrameId = requestAnimationFrame(scanFrameMinimal);
                        return;
                      }
                      
                      const code = barcode.rawValue;
                      const format = barcode.format;
                      
                      if (code === lastDetectedCode) {
                        detectionCount++;
                      } else {
                        lastDetectedCode = code;
                        detectionCount = 1;
                      }
                      
                      if (detectionCount < REQUIRED_DETECTIONS) {
                        animationFrameId = requestAnimationFrame(scanFrameMinimal);
                        return;
                      }
                      
                      lastDetectedCode = null;
                      detectionCount = 0;
                      scanAttempts++;
                      
                      if (isValidISBNCode(code, format)) {
                        console.log("Valid ISBN detected:", code);
                        document.getElementById('isbn').value = code;
                        stopScanner();
                        lastScanTime = now;
                        showNotification(`ISBN detected: ${code}`, 'success', 2000);
                        setTimeout(() => {
                          document.querySelector('button[name="fetch"]').click();
                        }, 500);
                      } else {
                        console.log("Invalid ISBN format:", code, format);
                        showNotification(`Invalid format: ${format}`, 'warning', 2000);
                        if (scanAttempts >= MAX_SCAN_ATTEMPTS) {
                          stopScanner();
                          showNotification('Too many invalid scans. Please try again.', 'error', 3000);
                        }
                      }
                    } else {
                      if (lastDetectedCode) {
                        lastDetectedCode = null;
                        detectionCount = 0;
                      }
                    }
                    
                    if (scanner) {
                      animationFrameId = requestAnimationFrame(scanFrameMinimal);
                    }
                  })
                  .catch(error => {
                    console.log("Scanning error:", error);
                    if (scanner) {
                      animationFrameId = requestAnimationFrame(scanFrameMinimal);
                    }
                  });
              }
              
              scanFrameMinimal();
              
              // Update UI for minimal mode
              scannerBtn.disabled = false;
              scannerBtn.textContent = '‚èπÔ∏è Stop Scanner';
              scannerBtn.className = 'btn-stop';
              showNotification('Scanner ready (basic mode)!', 'success', 3000);
              
            }).catch(fallbackErr => {
              console.error("Fallback camera init also failed:", fallbackErr);
              showNotification("Camera not available on this device", 'error', 5000);
              resetScannerUI();
            });
          } else {
            errorMessage += err.message;
            showNotification(errorMessage, 'error', 5000);
            resetScannerUI();
          }
        });
    });
  }

  function resetScannerUI() {
    scannerDiv.style.display = 'none';
    scannerBtn.disabled = false;
    scannerBtn.textContent = 'üì∑ Scan Barcode';
    scannerBtn.className = 'btn-scan';
  }
}

function stopScanner() {
  const scannerDiv = document.getElementById('scanner');
  const scannerBtn = document.getElementById('scannerBtn');
  const videoElement = document.getElementById('scanner-video');
  
  // Stop animation frame
  if (animationFrameId) {
    cancelAnimationFrame(animationFrameId);
    animationFrameId = null;
  }
  
  // Stop video stream
  if (videoStream) {
    videoStream.getTracks().forEach(track => track.stop());
    videoStream = null;
  }
  
  // Clean up scanner
  if (scanner) {
    scanner = null;
  }
  
  // Clean up video element
  if (videoElement) {
    videoElement.srcObject = null;
    videoElement.load();
  }
  
  scannerDiv.style.display = 'none';
  scannerBtn.disabled = false;
  scannerBtn.textContent = 'üì∑ Scan Barcode';
  scannerBtn.className = 'btn-scan';
}

// Add mobile-specific optimizations
function setupMobileOptimizations() {
  if (isMobile) {
    console.log("Mobile device detected:", navigator.userAgent);
    
    // Check if getUserMedia is supported
    if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
      console.error("getUserMedia not supported on this device");
      showNotification('Camera not supported on this device/browser', 'error', 5000);
    }
    
    // Prevent zoom on input focus
    const inputs = document.querySelectorAll('input[type="text"], input[type="date"]');
    inputs.forEach(input => {
      input.addEventListener('focus', function() {
        this.style.fontSize = '16px'; // Prevents zoom on iOS
      });
    });
    
    // Add touch-friendly button sizing
    const buttons = document.querySelectorAll('.btn-scan, .btn-stop, .btn-fetch');
    buttons.forEach(button => {
      button.style.minHeight = '44px'; // iOS minimum touch target
      button.style.minWidth = '44px';
    });
    
    // Add mobile-specific scanner optimizations
    const scannerDiv = document.getElementById('scanner');
    if (scannerDiv) {
      // Add mobile-specific styles
      scannerDiv.style.touchAction = 'none'; // Prevent default touch behaviors
      
      // Add mobile-specific instructions
      const mobileInstructions = document.createElement('div');
      mobileInstructions.id = 'mobile-instructions';
      mobileInstructions.style.cssText = `
        position: absolute;
        bottom: 10px;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(0,0,0,0.8);
        color: white;
        padding: 8px 12px;
        border-radius: 20px;
        font-size: 11px;
        text-align: center;
        z-index: 15;
        pointer-events: none;
        max-width: 90%;
        line-height: 1.3;
      `;
      mobileInstructions.textContent = 'üì± Hold 5-10cm from barcode ‚Ä¢ Tap to focus';
      scannerDiv.appendChild(mobileInstructions);
    }
    
    // Add mobile-specific error handling
    window.addEventListener('error', function(e) {
      if (e.message && e.message.includes('BarcodeDetector')) {
        console.log('BarcodeDetector error caught:', e.message);
        // Don't show error to user for BarcodeDetector errors, just log them
        e.preventDefault();
      }
    });
    
    // Add mobile-specific performance optimizations
    if ('connection' in navigator) {
      const connection = navigator.connection;
      if (connection.effectiveType === 'slow-2g' || connection.effectiveType === '2g') {
        console.log('Slow connection detected, optimizing scanner performance');
        // Reduce frame rate for slow connections
        window.SCANNER_FRAME_RATE = 10; // Lower frame rate for slow connections
      }
    }
  }
}

// Enhanced mobile focus detection
function setupMobileFocusDetection() {
  if (isMobile && videoStream) {
    const track = videoStream.getVideoTracks()[0];
    if (track && track.getCapabilities) {
      const capabilities = track.getCapabilities();
      
      // Log available capabilities for debugging
      console.log('Camera capabilities:', {
        focusMode: capabilities.focusMode,
        exposureMode: capabilities.exposureMode,
        whiteBalanceMode: capabilities.whiteBalanceMode,
        zoom: capabilities.zoom,
        torch: capabilities.torch
      });
      
      // Set up focus change detection
      if (capabilities.focusMode && capabilities.focusMode.length > 0) {
        track.addEventListener('ended', () => {
          console.log('Camera track ended');
        });
        
        track.addEventListener('mute', () => {
          console.log('Camera track muted');
        });
        
        track.addEventListener('unmute', () => {
          console.log('Camera track unmuted');
        });
      }
    }
  }
}

// Initialize mobile optimizations
document.addEventListener('DOMContentLoaded', setupMobileOptimizations);

// Add mobile-specific event listeners
document.addEventListener('DOMContentLoaded', function() {
  if (isMobile) {
    // Prevent double-tap zoom on scanner
    const scannerDiv = document.getElementById('scanner');
    if (scannerDiv) {
      let lastTouchEnd = 0;
      scannerDiv.addEventListener('touchend', function(event) {
        const now = (new Date()).getTime();
        if (now - lastTouchEnd <= 300) {
          event.preventDefault();
        }
        lastTouchEnd = now;
      }, false);
    }
    
    // Add mobile-specific keyboard handling
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape' && scanner) {
        stopScanner();
      }
      // Prevent zoom on mobile keyboards
      if (e.ctrlKey && (e.key === '+' || e.key === '-' || e.key === '0')) {
        e.preventDefault();
      }
    });
  }
});

window.addEventListener('beforeunload', stopScanner);

// Add keyboard shortcuts
document.addEventListener('keydown', function(e) {
  if (e.key === 'Escape' && scanner) {
    stopScanner();
  }
});

// (Optional, future) Native camera API integration for hybrid apps
if (window.Capacitor || window.cordova) {
  // Placeholder: Here you could use a native plugin for camera access
  // e.g., Capacitor Camera, Cordova plugins, etc.
  // This would require additional implementation and permissions
  console.log('Native camera API detected: consider using native plugin for best focus control.');
}
</script>
{% endblock %}