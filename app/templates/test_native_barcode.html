{% extends "base.html" %}
{% block title %}Test Native Barcode Scanner - MyBibliotheca{% endblock %}
{% block content %}

<style>
  .test-container {
    max-width: 600px;
    margin: 0 auto;
    padding: 20px;
    background: white;
    border-radius: 10px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
  }
  
  .test-header {
    text-align: center;
    margin-bottom: 30px;
  }
  
  .test-button {
    display: block;
    width: 100%;
    padding: 15px;
    margin: 10px 0;
    background: #007bff;
    color: white;
    border: none;
    border-radius: 8px;
    font-size: 16px;
    cursor: pointer;
    text-align: center;
  }
  
  .test-button:hover {
    background: #0056b3;
  }
  
  .test-button:disabled {
    background: #6c757d;
    cursor: not-allowed;
  }
  
  .result {
    margin: 20px 0;
    padding: 15px;
    border-radius: 8px;
    font-family: monospace;
    white-space: pre-wrap;
  }
  
  .result.success {
    background: #d4edda;
    color: #155724;
    border: 1px solid #c3e6cb;
  }
  
  .result.error {
    background: #f8d7da;
    color: #721c24;
    border: 1px solid #f5c6cb;
  }
  
  .result.info {
    background: #d1ecf1;
    color: #0c5460;
    border: 1px solid #bee5eb;
  }
  
  .status {
    text-align: center;
    font-weight: bold;
    margin: 10px 0;
  }
  
  .back-link {
    display: block;
    text-align: center;
    margin-top: 20px;
    color: #007bff;
    text-decoration: none;
  }
  
  .back-link:hover {
    text-decoration: underline;
  }
  
  /* Modal Dialog Styles */
  .modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.5);
    display: none;
    z-index: 1000;
    align-items: center;
    justify-content: center;
    pointer-events: auto;
  }
  
  .modal-dialog {
    background: white;
    border-radius: 12px;
    padding: 25px;
    max-width: 400px;
    width: 90%;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
    text-align: center;
    position: relative;
    z-index: 1001;
    pointer-events: auto;
  }
  
  .modal-title {
    font-size: 20px;
    font-weight: bold;
    margin-bottom: 15px;
    color: #333;
  }
  
  .modal-content {
    margin-bottom: 20px;
    line-height: 1.5;
    color: #666;
  }
  
  .modal-buttons {
    display: flex;
    gap: 10px;
    justify-content: center;
  }
  
  .modal-button {
    padding: 12px 20px;
    border: none;
    border-radius: 8px;
    font-size: 14px;
    font-weight: 500;
    cursor: pointer;
    flex: 1;
    max-width: 150px;
  }
  
  .modal-button.primary {
    background: #17a2b8;
    color: white;
  }
  
  .modal-button.secondary {
    background: #6c757d;
    color: white;
  }
  
  .modal-button:hover {
    opacity: 0.9;
  }
  
  .modal-path {
    font-size: 12px;
    color: #999;
    margin-top: 15px;
    padding: 10px;
    background: #f8f9fa;
    border-radius: 6px;
    border-left: 3px solid #17a2b8;
  }
</style>

<div class="test-container">
  <div class="test-header">
    <h1>üß™ Test Native Barcode Scanner</h1>
    <p>This page tests the MLKit native barcode scanner plugin</p>
  </div>
  
  <div id="status" class="status">Ready to test native barcode scanner</div>
  
  <button id="testNativeScanner" class="test-button">
    üì± Launch Native Barcode Scanner
  </button>
  
  <button id="debugPlugins" class="test-button" style="background: #6c757d;">
    üîç Debug Plugin Availability
  </button>
  
  <button id="testPermissions" class="test-button" style="background: #28a745;">
    üì∑ Test Camera Permissions
  </button>
  
  <button id="testBrowserScanner" class="test-button">
    üåê Test Browser Barcode Scanner (Fallback)
  </button>
  
  <div id="result" class="result info" style="display: none;"></div>
  
  <div id="logs" style="margin-top: 20px; font-family: monospace; font-size: 12px; max-height: 200px; overflow-y: auto; background: #f8f9fa; padding: 10px; border-radius: 5px;"></div>
  
  <a href="{{ url_for('main.index') }}" class="back-link">‚¨ÖÔ∏è Back to Library</a>
</div>

<!-- Permission Modal Dialog -->
<div id="permissionModal" class="modal-overlay">
  <div class="modal-dialog">
    <div class="modal-title">üì± Camera Permissions Required</div>
    <div class="modal-content">
      <p>The barcode scanner needs camera access to work.</p>
      <p>I'll try to open your device settings automatically. If that doesn't work, follow the manual steps below.</p>
    </div>
    <div class="modal-buttons">
      <button id="confirmOpenSettings" class="modal-button primary">
        üîß Try to Open Settings
      </button>
      <button id="cancelSettings" class="modal-button secondary">
        ‚ùå Cancel
      </button>
    </div>
    <div class="modal-path">
      <strong>üìã Manual Steps (if automatic doesn't work):</strong><br>
      1. <strong>Open Settings</strong> on your device<br>
      2. <strong>Find "Apps"</strong> or "Applications"<br>
      3. <strong>Search for "MyBibliotheca"</strong> in the app list<br>
      4. <strong>Tap on "MyBibliotheca"</strong><br>
      5. <strong>Tap "Permissions"</strong><br>
      6. <strong>Enable "Camera"</strong> permission<br>
      7. <strong>Return to this app</strong> and try again
    </div>
    <button id="closeModal" class="modal-button secondary" style="margin-top: 15px; width: 100%;">
      ‚úñÔ∏è Close Modal
    </button>
  </div>
</div>

<script>
  // Check if we're running in a Capacitor environment
  const isCapacitor = typeof Capacitor !== 'undefined';
  const isNative = isCapacitor && Capacitor.isNative;
  
  function log(message, type = 'info') {
    const logsDiv = document.getElementById('logs');
    const timestamp = new Date().toLocaleTimeString();
    const logEntry = document.createElement('div');
    logEntry.style.color = type === 'error' ? '#dc3545' : type === 'success' ? '#28a745' : '#007bff';
    logEntry.textContent = `[${timestamp}] ${message}`;
    logsDiv.appendChild(logEntry);
    logsDiv.scrollTop = logsDiv.scrollHeight;
    console.log(message);
  }
  
  function updateStatus(message, type = 'info') {
    const statusDiv = document.getElementById('status');
    statusDiv.textContent = message;
    statusDiv.className = `status ${type}`;
  }
  
  function showResult(message, type = 'info') {
    const resultDiv = document.getElementById('result');
    resultDiv.textContent = message;
    resultDiv.className = `result ${type}`;
    resultDiv.style.display = 'block';
  }
  
  function showPermissionHelp() {
    const modal = document.getElementById('permissionModal');
    modal.style.display = 'flex';
  }
  
  function hidePermissionHelp() {
    const modal = document.getElementById('permissionModal');
    modal.style.display = 'none';
  }
  
  function openDeviceSettings() {
    try {
      log('Attempting to open device settings...');
      
      if (isCapacitor) {
        // Use the capacitor-native-settings plugin
        openAppSettings();
      } else {
        showManualInstructions();
      }
    } catch (error) {
      log(`Error in openDeviceSettings: ${error.message}`, 'error');
      showManualInstructions();
    }
  }
  
  async function openAppSettings() {
    try {
      if (Capacitor.getPlatform() === 'android') {
        log('Opening Android app settings...');
        // Import and use the NativeSettings plugin with correct syntax
        const { NativeSettings, AndroidSettings } = await import('capacitor-native-settings');
        await NativeSettings.openAndroid({
          option: AndroidSettings.ApplicationDetails,
        });
        log('Android app settings opened successfully');
      } else if (Capacitor.getPlatform() === 'ios') {
        log('Opening iOS app settings...');
        const { NativeSettings, IOSSettings } = await import('capacitor-native-settings');
        await NativeSettings.openIOS({
          option: IOSSettings.App,
        });
        log('iOS app settings opened successfully');
      } else {
        log('Unknown platform, showing manual instructions');
        showManualInstructions();
      }
    } catch (error) {
      log(`Error opening app settings: ${error.message}`, 'error');
      // Fallback to manual instructions
      showManualInstructions();
    }
  }
  
  function showManualInstructions() {
    log('All automatic methods failed, showing manual instructions');
    alert('Please go to your device settings ‚Üí Apps ‚Üí MyBibliotheca ‚Üí Permissions ‚Üí Enable Camera');
  }
  
  // Initialize
  document.addEventListener('DOMContentLoaded', function() {
    log('Test page loaded');
    log(`Capacitor available: ${isCapacitor}`);
    log(`Native platform: ${isNative}`);
    
    if (isCapacitor) {
      log('Capacitor detected - native scanner should be available');
      
      // Log Capacitor object structure
      log('Capacitor object keys:');
      Object.keys(Capacitor).forEach(key => {
        log(`  - ${key}: ${typeof Capacitor[key]}`);
      });
      
      // Check what plugins are available
      if (Capacitor.Plugins) {
        log('Available plugins:');
        Object.keys(Capacitor.Plugins).forEach(plugin => {
          log(`  - ${plugin}`);
        });
      }
      
      updateStatus('Native scanner ready', 'success');
    } else {
      log('Running in browser - will use fallback scanner');
      updateStatus('Browser mode - using fallback scanner', 'info');
    }
    
    // Add click outside modal to close
    document.getElementById('permissionModal').addEventListener('click', function(e) {
      if (e.target === this) {
        hidePermissionHelp();
      }
    });
    
    // Add modal button event listeners
    document.getElementById('confirmOpenSettings').addEventListener('click', function() {
      log('User confirmed opening device settings');
      openDeviceSettings();
      // Don't close modal immediately - let the user see the logs
      // hidePermissionHelp();
    });
    
    document.getElementById('cancelSettings').addEventListener('click', function() {
      log('User cancelled opening device settings');
      hidePermissionHelp();
      showResult('Camera permissions are required to use the barcode scanner.', 'info');
    });
    
    document.getElementById('closeModal').addEventListener('click', function() {
      log('User closed modal manually');
      hidePermissionHelp();
    });
  });
  
  // Test Native Scanner
  document.getElementById('testNativeScanner').addEventListener('click', async function() {
    const button = this;
    button.disabled = true;
    button.textContent = 'üîÑ Launching...';
    
    try {
      if (!isCapacitor) {
        throw new Error('Capacitor not available - cannot use native scanner');
      }
      
      log('Attempting to launch native barcode scanner...');
      updateStatus('Launching native scanner...', 'info');
      
      // Get the BarcodeScanner plugin from Capacitor.Plugins
      const BarcodeScanner = Capacitor.Plugins.BarcodeScanner;
      if (!BarcodeScanner) {
        throw new Error('BarcodeScanner plugin not found in Capacitor.Plugins');
      }
      
      log('Found BarcodeScanner plugin in Capacitor.Plugins');
      
      // Check if scanning is supported
      const { supported } = await BarcodeScanner.isSupported();
      if (!supported) {
        throw new Error('Barcode scanning not supported on this device');
      }
      
      log('Barcode scanning is supported');
      
      // Check permissions
      log('Checking camera permissions...');
      const { granted } = await BarcodeScanner.checkPermissions();
      log(`Initial permission status: ${granted ? 'granted' : 'denied'}`);
      
      if (!granted) {
        log('Requesting camera permissions...');
        try {
          const { granted: newGranted } = await BarcodeScanner.requestPermissions();
          log(`Permission request result: ${newGranted ? 'granted' : 'denied'}`);
          if (!newGranted) {
            throw new Error('Camera permission denied by user');
          }
        } catch (permissionError) {
          log(`Permission request error: ${permissionError.message}`, 'error');
          showResult(`Camera permission error: ${permissionError.message}`, 'error');
          showPermissionHelp();
          return;
        }
      }
      
      log('Camera permissions granted');
      
      // Start scanning
      log('Starting barcode scan...');
      const { barcodes } = await BarcodeScanner.scan();
      
      if (barcodes && barcodes.length > 0) {
        const barcode = barcodes[0];
        const result = `‚úÖ Barcode Detected!
Format: ${barcode.format}
Value: ${barcode.rawValue}
Type: ${barcode.type}
Confidence: ${barcode.confidence || 'N/A'}`;
        
        log(`Native scanner detected: ${barcode.rawValue} (${barcode.format})`, 'success');
        showResult(result, 'success');
        updateStatus(`Detected: ${barcode.rawValue}`, 'success');
      } else {
        log('No barcode detected');
        showResult('No barcode detected', 'info');
        updateStatus('No barcode detected', 'info');
      }
      
    } catch (error) {
      log(`Native scanner error: ${error.message}`, 'error');
      showResult(`Error: ${error.message}`, 'error');
      updateStatus('Native scanner failed', 'error');
    } finally {
      button.disabled = false;
      button.textContent = 'üì± Launch Native Barcode Scanner';
    }
  });
  
  // Debug Plugin Availability
  document.getElementById('debugPlugins').addEventListener('click', function() {
    const button = this;
    button.disabled = true;
    button.textContent = 'üîç Debugging...';
    
    try {
      log('=== DEBUGGING PLUGIN AVAILABILITY ===');
      
      if (!isCapacitor) {
        log('‚ùå Capacitor not available', 'error');
        showResult('Capacitor not available in this environment', 'error');
        return;
      }
      
      log('‚úÖ Capacitor is available');
      
      // Log Capacitor object structure
      log('Capacitor object structure:');
      Object.keys(Capacitor).forEach(key => {
        log(`  - ${key}: ${typeof Capacitor[key]}`);
        if (typeof Capacitor[key] === 'object' && Capacitor[key] !== null) {
          try {
            const subKeys = Object.keys(Capacitor[key]);
            if (subKeys.length > 0) {
              log(`    Sub-keys: ${subKeys.join(', ')}`);
            }
          } catch (e) {
            log(`    (Could not enumerate sub-keys)`);
          }
        }
      });
      
      // Check global plugins
      if (Capacitor.Plugins) {
        log('Available plugins in Capacitor.Plugins:');
        Object.keys(Capacitor.Plugins).forEach(plugin => {
          log(`  - ${plugin}`);
        });
        
        if (Capacitor.Plugins.BarcodeScanner) {
          log('‚úÖ BarcodeScanner plugin found in Capacitor.Plugins', 'success');
        } else {
          log('‚ùå BarcodeScanner plugin NOT found in Capacitor.Plugins', 'error');
        }
      } else {
        log('‚ùå Capacitor.Plugins is not available', 'error');
      }
      
      // Check window object
      log('Checking window object for plugins...');
      if (window.BarcodeScanner) {
        log('‚úÖ BarcodeScanner found on window object', 'success');
      } else {
        log('‚ùå BarcodeScanner NOT found on window object', 'error');
      }
      
      // Note: ES6 imports don't work in Capacitor environment
      log('Note: ES6 imports are not available in Capacitor environment');
      log('Plugins must be accessed via Capacitor.Plugins');
      
      showResult('Debug information logged above. Check the logs for details.', 'info');
      
    } catch (error) {
      log(`Debug error: ${error.message}`, 'error');
      showResult(`Debug error: ${error.message}`, 'error');
    } finally {
      button.disabled = false;
      button.textContent = 'üîç Debug Plugin Availability';
    }
  });
  
  // Test Camera Permissions
  document.getElementById('testPermissions').addEventListener('click', async function() {
    const button = this;
    button.disabled = true;
    button.textContent = 'üì∑ Testing...';
    
    try {
      log('=== TESTING CAMERA PERMISSIONS ===');
      
      if (!isCapacitor) {
        throw new Error('Capacitor not available');
      }
      
      const BarcodeScanner = Capacitor.Plugins.BarcodeScanner;
      if (!BarcodeScanner) {
        throw new Error('BarcodeScanner plugin not found');
      }
      
      log('BarcodeScanner plugin found');
      
      // Check if scanning is supported
      log('Checking if barcode scanning is supported...');
      const { supported } = await BarcodeScanner.isSupported();
      log(`Barcode scanning supported: ${supported}`);
      
      if (!supported) {
        throw new Error('Barcode scanning not supported on this device');
      }
      
      // Check current permissions
      log('Checking current camera permissions...');
      const { granted } = await BarcodeScanner.checkPermissions();
      log(`Current permission status: ${granted ? 'GRANTED' : 'DENIED'}`);
      
      if (granted) {
        log('‚úÖ Camera permissions already granted', 'success');
        showResult('Camera permissions are already granted!', 'success');
        return;
      }
      
      // Request permissions
      log('Requesting camera permissions...');
      const { granted: newGranted } = await BarcodeScanner.requestPermissions();
      log(`Permission request result: ${newGranted ? 'GRANTED' : 'DENIED'}`);
      
      if (newGranted) {
        log('‚úÖ Camera permissions granted successfully!', 'success');
        showResult('Camera permissions granted successfully!', 'success');
        hidePermissionHelp();
      } else {
        log('‚ùå Camera permissions denied', 'error');
        showResult('Camera permissions were denied. Please grant camera permissions in your device settings.', 'error');
        showPermissionHelp();
      }
      
    } catch (error) {
      log(`Permission test error: ${error.message}`, 'error');
      showResult(`Error: ${error.message}`, 'error');
    } finally {
      button.disabled = false;
      button.textContent = 'üì∑ Test Camera Permissions';
    }
  });
  
  // Test Browser Scanner (Fallback)
  document.getElementById('testBrowserScanner').addEventListener('click', async function() {
    const button = this;
    button.disabled = true;
    button.textContent = 'üîÑ Starting...';
    
    try {
      log('Testing browser-based barcode scanner...');
      updateStatus('Starting browser scanner...', 'info');
      
      // Check if BarcodeDetector is supported
      if (!('BarcodeDetector' in window)) {
        throw new Error('BarcodeDetector not supported in this browser');
      }
      
      log('BarcodeDetector is supported');
      
      // Create a simple video element for testing
      const video = document.createElement('video');
      video.style.width = '100%';
      video.style.height = '300px';
      video.style.border = '2px solid #007bff';
      video.style.borderRadius = '8px';
      video.style.marginTop = '10px';
      
      // Replace result div with video
      const resultDiv = document.getElementById('result');
      resultDiv.innerHTML = '';
      resultDiv.appendChild(video);
      resultDiv.style.display = 'block';
      
      // Get camera stream
      const stream = await navigator.mediaDevices.getUserMedia({
        video: { facingMode: 'environment' }
      });
      
      video.srcObject = stream;
      await video.play();
      
      log('Camera stream started');
      updateStatus('Camera active - point at barcode', 'info');
      
      // Create BarcodeDetector
      const barcodeDetector = new BarcodeDetector({
        formats: ['ean_13', 'ean_8', 'code_128', 'code_39']
      });
      
      // Scan for barcodes
      const scanInterval = setInterval(async () => {
        try {
          const barcodes = await barcodeDetector.detect(video);
          if (barcodes.length > 0) {
            const barcode = barcodes[0];
            const result = `‚úÖ Browser Scanner Detected!
Format: ${barcode.format}
Value: ${barcode.rawValue}`;
            
            log(`Browser scanner detected: ${barcode.rawValue} (${barcode.format})`, 'success');
            showResult(result, 'success');
            updateStatus(`Detected: ${barcode.rawValue}`, 'success');
            
            // Stop scanning
            clearInterval(scanInterval);
            stream.getTracks().forEach(track => track.stop());
            video.remove();
          }
        } catch (error) {
          log(`Browser scan error: ${error.message}`, 'error');
        }
      }, 1000);
      
      // Stop scanning after 30 seconds
      setTimeout(() => {
        clearInterval(scanInterval);
        stream.getTracks().forEach(track => track.stop());
        video.remove();
        if (resultDiv.innerHTML === '') {
          showResult('No barcode detected within 30 seconds', 'info');
          updateStatus('Scan timeout', 'info');
        }
      }, 30000);
      
    } catch (error) {
      log(`Browser scanner error: ${error.message}`, 'error');
      showResult(`Error: ${error.message}`, 'error');
      updateStatus('Browser scanner failed', 'error');
    } finally {
      button.disabled = false;
      button.textContent = 'üåê Test Browser Barcode Scanner (Fallback)';
    }
  });
</script>

{% endblock %}