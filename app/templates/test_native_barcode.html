{% extends "base.html" %}
{% block title %}Test Native Barcode Scanner - MyBibliotheca{% endblock %}
{% block content %}

<style>
  .test-container {
    max-width: 600px;
    margin: 0 auto;
    padding: 20px;
    background: white;
    border-radius: 10px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
  }
  
  .test-header {
    text-align: center;
    margin-bottom: 30px;
  }
  
  .test-button {
    display: block;
    width: 100%;
    padding: 15px;
    margin: 10px 0;
    background: #007bff;
    color: white;
    border: none;
    border-radius: 8px;
    font-size: 16px;
    cursor: pointer;
    text-align: center;
  }
  
  .test-button:hover {
    background: #0056b3;
  }
  
  .test-button:disabled {
    background: #6c757d;
    cursor: not-allowed;
  }
  
  .result {
    margin: 20px 0;
    padding: 15px;
    border-radius: 8px;
    font-family: monospace;
    white-space: pre-wrap;
  }
  
  .result.success {
    background: #d4edda;
    color: #155724;
    border: 1px solid #c3e6cb;
  }
  
  .result.error {
    background: #f8d7da;
    color: #721c24;
    border: 1px solid #f5c6cb;
  }
  
  .result.info {
    background: #d1ecf1;
    color: #0c5460;
    border: 1px solid #bee5eb;
  }
  
  .status {
    text-align: center;
    font-weight: bold;
    margin: 10px 0;
  }
  
  .back-link {
    display: block;
    text-align: center;
    margin-top: 20px;
    color: #007bff;
    text-decoration: none;
  }
  
  .back-link:hover {
    text-decoration: underline;
  }
</style>

<div class="test-container">
  <div class="test-header">
    <h1>üß™ Test Native Barcode Scanner</h1>
    <p>This page tests the MLKit native barcode scanner plugin</p>
  </div>
  
  <div id="status" class="status">Ready to test native barcode scanner</div>
  
  <button id="testNativeScanner" class="test-button">
    üì± Launch Native Barcode Scanner
  </button>
  
  <button id="debugPlugins" class="test-button" style="background: #6c757d;">
    üîç Debug Plugin Availability
  </button>
  
  <button id="testBrowserScanner" class="test-button">
    üåê Test Browser Barcode Scanner (Fallback)
  </button>
  
  <div id="result" class="result info" style="display: none;"></div>
  
  <div id="logs" style="margin-top: 20px; font-family: monospace; font-size: 12px; max-height: 200px; overflow-y: auto; background: #f8f9fa; padding: 10px; border-radius: 5px;"></div>
  
  <a href="{{ url_for('main.index') }}" class="back-link">‚¨ÖÔ∏è Back to Library</a>
</div>

<script>
  // Check if we're running in a Capacitor environment
  const isCapacitor = typeof Capacitor !== 'undefined';
  const isNative = isCapacitor && Capacitor.isNative;
  
  function log(message, type = 'info') {
    const logsDiv = document.getElementById('logs');
    const timestamp = new Date().toLocaleTimeString();
    const logEntry = document.createElement('div');
    logEntry.style.color = type === 'error' ? '#dc3545' : type === 'success' ? '#28a745' : '#007bff';
    logEntry.textContent = `[${timestamp}] ${message}`;
    logsDiv.appendChild(logEntry);
    logsDiv.scrollTop = logsDiv.scrollHeight;
    console.log(message);
  }
  
  function updateStatus(message, type = 'info') {
    const statusDiv = document.getElementById('status');
    statusDiv.textContent = message;
    statusDiv.className = `status ${type}`;
  }
  
  function showResult(message, type = 'info') {
    const resultDiv = document.getElementById('result');
    resultDiv.textContent = message;
    resultDiv.className = `result ${type}`;
    resultDiv.style.display = 'block';
  }
  
  // Initialize
  document.addEventListener('DOMContentLoaded', function() {
    log('Test page loaded');
    log(`Capacitor available: ${isCapacitor}`);
    log(`Native platform: ${isNative}`);
    
    if (isCapacitor) {
      log('Capacitor detected - native scanner should be available');
      log(`Capacitor version: ${Capacitor.getVersion()}`);
      log(`Platform: ${Capacitor.getPlatform()}`);
      
      // Check what plugins are available
      if (Capacitor.Plugins) {
        log('Available plugins:');
        Object.keys(Capacitor.Plugins).forEach(plugin => {
          log(`  - ${plugin}`);
        });
      }
      
      updateStatus('Native scanner ready', 'success');
    } else {
      log('Running in browser - will use fallback scanner');
      updateStatus('Browser mode - using fallback scanner', 'info');
    }
  });
  
  // Test Native Scanner
  document.getElementById('testNativeScanner').addEventListener('click', async function() {
    const button = this;
    button.disabled = true;
    button.textContent = 'üîÑ Launching...';
    
    try {
      if (!isCapacitor) {
        throw new Error('Capacitor not available - cannot use native scanner');
      }
      
      log('Attempting to launch native barcode scanner...');
      updateStatus('Launching native scanner...', 'info');
      
      // Check if the plugin is available globally
      let BarcodeScanner;
      if (Capacitor.Plugins && Capacitor.Plugins.BarcodeScanner) {
        BarcodeScanner = Capacitor.Plugins.BarcodeScanner;
        log('Found BarcodeScanner plugin in Capacitor.Plugins');
      } else {
        // Try to import the barcode scanner plugin
        try {
          const module = await import('@capacitor-mlkit/barcode-scanning');
          BarcodeScanner = module.BarcodeScanner;
          log('Successfully imported BarcodeScanner plugin via ES6 import');
        } catch (importError) {
          log(`Import error: ${importError.message}`, 'error');
          log('This usually means the plugin is not properly installed or not available in this environment', 'error');
          throw new Error(`Failed to load barcode scanner plugin: ${importError.message}`);
        }
      }
      
      // Check if scanning is supported
      const { supported } = await BarcodeScanner.isSupported();
      if (!supported) {
        throw new Error('Barcode scanning not supported on this device');
      }
      
      log('Barcode scanning is supported');
      
      // Check permissions
      const { granted } = await BarcodeScanner.checkPermissions();
      if (!granted) {
        log('Requesting camera permissions...');
        const { granted: newGranted } = await BarcodeScanner.requestPermissions();
        if (!newGranted) {
          throw new Error('Camera permission denied');
        }
      }
      
      log('Camera permissions granted');
      
      // Start scanning
      log('Starting barcode scan...');
      const { barcodes } = await BarcodeScanner.scan();
      
      if (barcodes && barcodes.length > 0) {
        const barcode = barcodes[0];
        const result = `‚úÖ Barcode Detected!
Format: ${barcode.format}
Value: ${barcode.rawValue}
Type: ${barcode.type}
Confidence: ${barcode.confidence || 'N/A'}`;
        
        log(`Native scanner detected: ${barcode.rawValue} (${barcode.format})`, 'success');
        showResult(result, 'success');
        updateStatus(`Detected: ${barcode.rawValue}`, 'success');
      } else {
        log('No barcode detected');
        showResult('No barcode detected', 'info');
        updateStatus('No barcode detected', 'info');
      }
      
    } catch (error) {
      log(`Native scanner error: ${error.message}`, 'error');
      showResult(`Error: ${error.message}`, 'error');
      updateStatus('Native scanner failed', 'error');
    } finally {
      button.disabled = false;
      button.textContent = 'üì± Launch Native Barcode Scanner';
    }
  });
  
  // Debug Plugin Availability
  document.getElementById('debugPlugins').addEventListener('click', function() {
    const button = this;
    button.disabled = true;
    button.textContent = 'üîç Debugging...';
    
    try {
      log('=== DEBUGGING PLUGIN AVAILABILITY ===');
      
      if (!isCapacitor) {
        log('‚ùå Capacitor not available', 'error');
        showResult('Capacitor not available in this environment', 'error');
        return;
      }
      
      log('‚úÖ Capacitor is available');
      log(`Capacitor version: ${Capacitor.getVersion()}`);
      log(`Platform: ${Capacitor.getPlatform()}`);
      log(`Native: ${Capacitor.isNative}`);
      
      // Check global plugins
      if (Capacitor.Plugins) {
        log('Available plugins in Capacitor.Plugins:');
        Object.keys(Capacitor.Plugins).forEach(plugin => {
          log(`  - ${plugin}`);
        });
        
        if (Capacitor.Plugins.BarcodeScanner) {
          log('‚úÖ BarcodeScanner plugin found in Capacitor.Plugins', 'success');
        } else {
          log('‚ùå BarcodeScanner plugin NOT found in Capacitor.Plugins', 'error');
        }
      } else {
        log('‚ùå Capacitor.Plugins is not available', 'error');
      }
      
      // Check window object
      log('Checking window object for plugins...');
      if (window.BarcodeScanner) {
        log('‚úÖ BarcodeScanner found on window object', 'success');
      } else {
        log('‚ùå BarcodeScanner NOT found on window object', 'error');
      }
      
      // Check if we can import the module
      log('Testing ES6 import...');
      import('@capacitor-mlkit/barcode-scanning')
        .then(module => {
          log('‚úÖ ES6 import successful', 'success');
          log(`Module keys: ${Object.keys(module).join(', ')}`);
          if (module.BarcodeScanner) {
            log('‚úÖ BarcodeScanner found in imported module', 'success');
          } else {
            log('‚ùå BarcodeScanner NOT found in imported module', 'error');
          }
        })
        .catch(error => {
          log(`‚ùå ES6 import failed: ${error.message}`, 'error');
        });
      
      showResult('Debug information logged above. Check the logs for details.', 'info');
      
    } catch (error) {
      log(`Debug error: ${error.message}`, 'error');
      showResult(`Debug error: ${error.message}`, 'error');
    } finally {
      button.disabled = false;
      button.textContent = 'üîç Debug Plugin Availability';
    }
  });
  
  // Test Browser Scanner (Fallback)
  document.getElementById('testBrowserScanner').addEventListener('click', async function() {
    const button = this;
    button.disabled = true;
    button.textContent = 'üîÑ Starting...';
    
    try {
      log('Testing browser-based barcode scanner...');
      updateStatus('Starting browser scanner...', 'info');
      
      // Check if BarcodeDetector is supported
      if (!('BarcodeDetector' in window)) {
        throw new Error('BarcodeDetector not supported in this browser');
      }
      
      log('BarcodeDetector is supported');
      
      // Create a simple video element for testing
      const video = document.createElement('video');
      video.style.width = '100%';
      video.style.height = '300px';
      video.style.border = '2px solid #007bff';
      video.style.borderRadius = '8px';
      video.style.marginTop = '10px';
      
      // Replace result div with video
      const resultDiv = document.getElementById('result');
      resultDiv.innerHTML = '';
      resultDiv.appendChild(video);
      resultDiv.style.display = 'block';
      
      // Get camera stream
      const stream = await navigator.mediaDevices.getUserMedia({
        video: { facingMode: 'environment' }
      });
      
      video.srcObject = stream;
      await video.play();
      
      log('Camera stream started');
      updateStatus('Camera active - point at barcode', 'info');
      
      // Create BarcodeDetector
      const barcodeDetector = new BarcodeDetector({
        formats: ['ean_13', 'ean_8', 'code_128', 'code_39']
      });
      
      // Scan for barcodes
      const scanInterval = setInterval(async () => {
        try {
          const barcodes = await barcodeDetector.detect(video);
          if (barcodes.length > 0) {
            const barcode = barcodes[0];
            const result = `‚úÖ Browser Scanner Detected!
Format: ${barcode.format}
Value: ${barcode.rawValue}`;
            
            log(`Browser scanner detected: ${barcode.rawValue} (${barcode.format})`, 'success');
            showResult(result, 'success');
            updateStatus(`Detected: ${barcode.rawValue}`, 'success');
            
            // Stop scanning
            clearInterval(scanInterval);
            stream.getTracks().forEach(track => track.stop());
            video.remove();
          }
        } catch (error) {
          log(`Browser scan error: ${error.message}`, 'error');
        }
      }, 1000);
      
      // Stop scanning after 30 seconds
      setTimeout(() => {
        clearInterval(scanInterval);
        stream.getTracks().forEach(track => track.stop());
        video.remove();
        if (resultDiv.innerHTML === '') {
          showResult('No barcode detected within 30 seconds', 'info');
          updateStatus('Scan timeout', 'info');
        }
      }, 30000);
      
    } catch (error) {
      log(`Browser scanner error: ${error.message}`, 'error');
      showResult(`Error: ${error.message}`, 'error');
      updateStatus('Browser scanner failed', 'error');
    } finally {
      button.disabled = false;
      button.textContent = 'üåê Test Browser Barcode Scanner (Fallback)';
    }
  });
</script>

{% endblock %} 