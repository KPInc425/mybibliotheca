{% extends "base.html" %}
{% block title %}Add Book - MyBibliotheca{% endblock %}
{% block content %}

<style>
  :root {
    --primary-brown: #8B4513;
    --light-brown: #D2B48C;
    --cream: #F5F5DC;
    --warm-white: #FEFEFE;
    --gold: #DAA520;
    --shadow: rgba(0,0,0,0.1);
    --hover-shadow: rgba(0,0,0,0.2);
  }

  .library-header {
    background: linear-gradient(135deg, var(--primary-brown) 0%, var(--light-brown) 100%);
    color: white;
    padding: 2rem;
    margin-bottom: 2rem;
    border-radius: 15px;
    text-align: center;
    position: relative;
    overflow: hidden;
  }

  .library-header::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: url('https://www.transparenttextures.com/patterns/paper-fibers.png');
    opacity: 0.3;
  }

  .library-header h1 {
    font-size: 2.5rem;
    font-weight: 700;
    margin: 0;
    text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
    position: relative;
    z-index: 1;
  }

  .form-container {
    background: var(--cream);
    border-radius: 20px;
    padding: 2rem;
    box-shadow: 0 8px 25px var(--shadow);
    border: 3px solid var(--light-brown);
  }

  .scanner-section {
    background: var(--warm-white);
    border: 2px solid var(--light-brown);
    border-radius: 15px;
    padding: 1.5rem;
    margin-bottom: 2rem;
    text-align: center;
  }

  .scanner-buttons {
    display: flex;
    gap: 1rem;
    justify-content: center;
    margin-bottom: 1rem;
  }

  .btn-scan {
    background: linear-gradient(135deg, var(--primary-brown), var(--light-brown));
    border: none;
    color: white;
    padding: 0.75rem 1.5rem;
    border-radius: 10px;
    font-weight: 600;
    transition: all 0.3s ease;
    box-shadow: 0 4px 15px rgba(139, 69, 19, 0.3);
  }

  .btn-scan:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(139, 69, 19, 0.4);
    color: white;
  }

  .btn-stop {
    background: linear-gradient(135deg, #dc3545, #c82333);
    border: none;
    color: white;
    padding: 0.75rem 1.5rem;
    border-radius: 10px;
    font-weight: 600;
    transition: all 0.3s ease;
    box-shadow: 0 4px 15px rgba(220, 53, 69, 0.3);
  }

  .btn-stop:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(220, 53, 69, 0.4);
    color: white;
  }

  #scanner {
    border: 3px solid var(--primary-brown) !important;
    border-radius: 15px !important;
    margin: 1rem auto !important;
    box-shadow: 0 8px 25px var(--shadow) !important;
    position: relative;
    overflow: hidden;
  }

  #scanner-overlay {
    border: 3px solid var(--gold) !important;
    box-shadow: 0 0 20px rgba(218, 165, 32, 0.6);
    animation: pulse 2s infinite;
  }

  @keyframes pulse {
    0% { box-shadow: 0 0 20px rgba(218, 165, 32, 0.6); }
    50% { box-shadow: 0 0 30px rgba(218, 165, 32, 0.8); }
    100% { box-shadow: 0 0 20px rgba(218, 165, 32, 0.6); }
  }

  .form-group {
    margin-bottom: 1.5rem;
  }

  .form-group label {
    display: block;
    font-weight: 600;
    color: var(--primary-brown);
    margin-bottom: 0.5rem;
    font-size: 1.1rem;
  }

  .form-control {
    width: 100%;
    padding: 0.75rem 1rem;
    border: 2px solid var(--light-brown);
    border-radius: 10px;
    font-size: 1rem;
    transition: all 0.3s ease;
    background: var(--warm-white);
  }

  .form-control:focus {
    outline: none;
    border-color: var(--gold);
    box-shadow: 0 0 15px rgba(218, 165, 32, 0.3);
  }

  .btn-fetch {
    background: linear-gradient(135deg, var(--gold), #B8860B);
    border: none;
    color: white;
    padding: 0.75rem 2rem;
    border-radius: 10px;
    font-weight: 600;
    transition: all 0.3s ease;
    box-shadow: 0 4px 15px rgba(218, 165, 32, 0.3);
    margin-bottom: 1.5rem;
  }

  .btn-fetch:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(218, 165, 32, 0.4);
    color: white;
  }

  .book-cover-preview {
    text-align: center;
    margin: 2rem 0;
    padding: 1.5rem;
    background: var(--warm-white);
    border: 2px solid var(--light-brown);
    border-radius: 15px;
  }

  .book-cover-preview img {
    max-height: 200px;
    border-radius: 10px;
    box-shadow: 0 8px 25px var(--shadow);
  }

  .checkbox-group {
    display: flex;
    flex-direction: column;
    gap: 1rem;
    margin: 2rem 0;
    background: var(--warm-white);
    padding: 1.5rem;
    border-radius: 15px;
    border: 2px solid var(--light-brown);
  }

  .checkbox-item {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    font-size: 1.1rem;
    color: var(--primary-brown);
    font-weight: 500;
  }

  .checkbox-item input[type="checkbox"] {
    width: 20px;
    height: 20px;
    accent-color: var(--primary-brown);
  }

  .btn-submit {
    background: linear-gradient(135deg, var(--primary-brown), var(--light-brown));
    border: none;
    color: white;
    padding: 1rem 3rem;
    border-radius: 15px;
    font-weight: 700;
    font-size: 1.2rem;
    transition: all 0.3s ease;
    box-shadow: 0 6px 20px rgba(139, 69, 19, 0.3);
    width: 100%;
    margin: 2rem 0 1rem 0;
  }

  .btn-submit:hover {
    transform: translateY(-3px);
    box-shadow: 0 8px 25px rgba(139, 69, 19, 0.4);
    color: white;
  }

  .back-link {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    color: var(--primary-brown);
    text-decoration: none;
    font-weight: 600;
    padding: 0.75rem 1.5rem;
    border: 2px solid var(--light-brown);
    border-radius: 10px;
    transition: all 0.3s ease;
    background: var(--warm-white);
  }

  .back-link:hover {
    background: var(--light-brown);
    color: white;
    transform: translateX(-5px);
  }

  .row {
    display: flex;
    gap: 1rem;
    flex-wrap: wrap;
  }

  .col-md-6 {
    flex: 1;
    min-width: 250px;
  }

  @media (max-width: 768px) {
    .scanner-buttons {
      flex-direction: column;
      align-items: center;
    }
    
    .row {
      flex-direction: column;
    }
    
    .library-header h1 {
      font-size: 2rem;
    }
    
    #scanner {
      height: 300px !important;
      max-width: 100% !important;
      margin: 1rem 0 !important;
    }
    
    .btn-scan, .btn-stop, .btn-fetch {
      min-height: 44px;
      min-width: 44px;
      font-size: 1rem;
    }
    
    /* Better mobile scanner positioning */
    #scanner-overlay {
      width: 80% !important;
      height: 60% !important;
    }
  }

  /* Floating Notification System */
  .floating-notification {
    position: fixed;
    top: 20px;
    right: 20px;
    padding: 12px 20px;
    border-radius: 8px;
    color: white;
    font-weight: 600;
    z-index: 9999;
    transform: translateX(100%);
    transition: transform 0.3s ease;
    box-shadow: 0 4px 12px rgba(0,0,0,0.3);
  }

  .floating-notification.show {
    transform: translateX(0);
  }

  .floating-notification.success {
    background: linear-gradient(135deg, #28a745, #20c997);
  }

  .floating-notification.error {
    background: linear-gradient(135deg, #dc3545, #c82333);
  }

  .floating-notification.warning {
    background: linear-gradient(135deg, #ffc107, #e0a800);
    color: #212529;
  }

  .floating-notification.info {
    background: linear-gradient(135deg, #17a2b8, #138496);
  }

  @media (max-width: 768px) {
  }
</style>

<div class="library-header">
  <h1>üìö Add New Book</h1>
  <p class="mb-0">Scan, search, or manually add books to your library</p>
</div>

<!-- Floating Notification Container -->
<div id="notification-container"></div>

<div class="form-container">
  <form method="post">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
    
    <!-- Scanner Section -->
    <div class="scanner-section">
      <h4 style="color: var(--primary-brown); margin-bottom: 1rem;">üì± Barcode Scanner</h4>
      
      <div class="scanner-buttons">
        <button type="button" class="btn-scan" onclick="startScanner()">
          üì∑ Scan Barcode
        </button>
        <button type="button" class="btn-stop" onclick="stopScanner()" style="display: none;" id="stopBtn">
          ‚èπÔ∏è Stop Scanner
        </button>
      </div>
      
      <!-- Scanner viewport -->
      <div id="scanner" style="
        width: 100%;
        max-width: 400px;
        height: 300px;
        display: none;
        margin: 1rem auto;
        overflow: hidden;
        position: relative;
        background-color: #000;
        border-radius: 15px;
      ">
        <div id="scanner-overlay" style="
          position: absolute;
          top: 50%;
          left: 50%;
          transform: translate(-50%, -50%);
          width: 70%;
          height: 50%;
          z-index: 10;
          pointer-events: none;
          border: 2px solid var(--gold);
          border-radius: 10px;
        "></div>
      </div>
    </div>

    <!-- ISBN and Fetch Section -->
    <div class="form-group">
      <label for="isbn">üìñ ISBN Number</label>
      <input id="isbn" name="isbn" class="form-control" value="{{ request.form.isbn or '' }}" 
             type="text" pattern="[\d-]+" title="Enter a valid ISBN (digits and hyphens only)"
             placeholder="Enter ISBN or scan barcode above">
      <button name="fetch" value="1" type="submit" class="btn-fetch mt-2">
        üîç Fetch Book Data
      </button>
    </div>

    <!-- Book Details -->
    <div class="row">
      <div class="col-md-6">
        <div class="form-group">
          <label for="title">üìö Title</label>
          <input id="title" name="title" class="form-control" 
                 value="{{ book_data.title if book_data else request.form.title or '' }}"
                 placeholder="Enter book title">
        </div>
      </div>
      <div class="col-md-6">
        <div class="form-group">
          <label for="author">‚úçÔ∏è Author</label>
          <input name="author" class="form-control" 
                 value="{{ book_data.author if book_data else request.form.author or '' }}"
                 placeholder="Enter author name">
        </div>
      </div>
    </div>

    <div class="row">
      <div class="col-md-6">
        <div class="form-group">
          <label for="start_date">üìÖ Start Date</label>
          <input name="start_date" type="date" class="form-control">
        </div>
      </div>
      <div class="col-md-6">
        <div class="form-group">
          <label for="finish_date">üèÅ Finish Date</label>
          <input name="finish_date" type="date" class="form-control">
        </div>
      </div>
    </div>

    <!-- Book Cover Preview -->
    {% if book_data and book_data.cover %}
    <div class="book-cover-preview">
      <h5 style="color: var(--primary-brown); margin-bottom: 1rem;">üì∏ Book Cover</h5>
      <img src="{{ book_data.cover }}" alt="Book Cover" class="img-fluid">
    </div>
    {% endif %}

    <!-- Options -->
    <div class="checkbox-group">
      <h5 style="color: var(--primary-brown); margin-bottom: 1rem;">‚öôÔ∏è Reading Options</h5>
      <label class="checkbox-item">
        <input type="checkbox" name="want_to_read" {% if request.form.want_to_read %}checked{% endif %}>
        <span>üìã Want to Read (Add to reading list)</span>
      </label>
      <label class="checkbox-item">
        <input type="checkbox" name="library_only" {% if request.form.library_only %}checked{% endif %}>
        <span>üìö Library Only (Reference/Collection)</span>
      </label>
    </div>

    <!-- Submit Button -->
    <button type="submit" name="add" class="btn-submit">
      ‚ûï Add Book to Library
    </button>
  </form>

  <!-- Back Link -->
  <div style="text-align: center; margin-top: 1rem;">
    <a href="{{ url_for('main.index') }}" class="back-link">
      ‚¨ÖÔ∏è Back to Library
    </a>
  </div>
</div>

<!-- QuaggaJS (local file) -->
<script src="{{ url_for('static', filename='quagga.min.js') }}"></script>
<script>
let quaggaStarted = false;
let lastScanTime = 0;
const SCAN_COOLDOWN = 2000;
let scanAttempts = 0;
const MAX_SCAN_ATTEMPTS = 10;

// Global mobile detection
const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);

// Enhanced validation - check both format and code structure
function isValidISBNCode(code, format) {
  const cleanCode = code.replace(/[-\s]/g, '');
  
  // First check format
  if (!isLikelyISBNFormat(format)) {
    return false;
  }
  
  // Then check code structure
  if (cleanCode.length === 10 || cleanCode.length === 13) {
    if (cleanCode.length === 13) {
      return cleanCode.startsWith('978') || cleanCode.startsWith('979');
    }
    return /^\d{9}[\dX]$/i.test(cleanCode);
  }
  
  return false;
}

// Check if the detected format is likely to be an ISBN
function isLikelyISBNFormat(format) {
  // ISBNs are typically EAN-13 or Code 128
  const isbnFormats = ['ean_13', 'ean', 'code_128', 'code_39'];
  return isbnFormats.includes(format);
}

// Floating notification system
function showNotification(message, type = 'info', duration = 3000) {
  const container = document.getElementById('notification-container');
  const notification = document.createElement('div');
  notification.className = `floating-notification ${type}`;
  notification.textContent = message;
  
  container.appendChild(notification);
  
  // Trigger animation
  setTimeout(() => {
    notification.classList.add('show');
  }, 10);
  
  // Remove notification
  setTimeout(() => {
    notification.classList.remove('show');
    setTimeout(() => {
      if (container.contains(notification)) {
        container.removeChild(notification);
      }
    }, 300);
  }, duration);
}

// Get optimal camera constraints based on device
async function getCameraConstraints() {
  if (isMobile) {
    const bestCameraId = await getBestCamera();
    
    return {
      width: { min: 640, ideal: 1280, max: 1920 },
      height: { min: 480, ideal: 720, max: 1080 },
      facingMode: "environment",
      // Use the best camera for barcode scanning
      deviceId: bestCameraId ? { exact: bestCameraId } : undefined,
      frameRate: { ideal: 15, max: 30 },
      // Focus settings for better barcode scanning
      focusMode: "continuous",
      exposureMode: "continuous",
      whiteBalanceMode: "continuous",
      // Ensure we get the main camera (not wide-angle)
      aspectRatio: { ideal: 4/3 },
      // Try to get the standard camera, not ultra-wide
      zoom: { ideal: 1.0, min: 0.8, max: 1.2 }
    };
  } else {
    return {
      width: { min: 640, ideal: 1280, max: 1920 },
      height: { min: 480, ideal: 720, max: 1080 },
      facingMode: "environment",
      focusMode: "continuous",
      exposureMode: "continuous"
    };
  }
}

// Check if camera is available
async function checkCameraPermission() {
  try {
    const stream = await navigator.mediaDevices.getUserMedia({ 
      video: { facingMode: "environment" } 
    });
    stream.getTracks().forEach(track => track.stop());
    return true;
  } catch (error) {
    console.error("Camera permission check failed:", error);
    return false;
  }
}

// Get the best camera for barcode scanning
async function getBestCamera() {
  try {
    const devices = await navigator.mediaDevices.enumerateDevices();
    const videoDevices = devices.filter(device => device.kind === 'videoinput');
    
    console.log("Available cameras:", videoDevices.map(d => d.label || d.deviceId));
    
    // First, filter for back-facing cameras only
    const backCameras = videoDevices.filter(device => {
      const label = device.label.toLowerCase();
      return label.includes('back') || label.includes('rear') || label.includes('environment');
    });
    
    console.log("Back-facing cameras:", backCameras.map(d => d.label || d.deviceId));
    
    if (backCameras.length === 0) {
      console.log("No back-facing cameras found, using first available camera");
      return videoDevices.length > 0 ? videoDevices[0].deviceId : undefined;
    }
    
    // Among back cameras, prefer the main camera (avoid wide-angle, ultra-wide, etc.)
    const mainBackCamera = backCameras.find(device => {
      const label = device.label.toLowerCase();
      // Avoid wide-angle, ultra-wide, or telephoto cameras
      return !label.includes('wide') && 
             !label.includes('ultra') && 
             !label.includes('telephoto') &&
             !label.includes('macro');
    });
    
    if (mainBackCamera) {
      console.log("Selected main back camera:", mainBackCamera.label || mainBackCamera.deviceId);
      return mainBackCamera.deviceId;
    }
    
    // Fallback to first back camera
    console.log("Using fallback back camera:", backCameras[0].label || backCameras[0].deviceId);
    return backCameras[0].deviceId;
  } catch (error) {
    console.error("Error enumerating cameras:", error);
    return undefined;
  }
}

function startScanner() {
  const scannerDiv = document.getElementById('scanner');
  const stopBtn = document.getElementById('stopBtn');
  const startBtn = document.querySelector('.btn-scan');
  
  // Show loading state
  startBtn.disabled = true;
  startBtn.textContent = 'üîÑ Starting...';
  
  scannerDiv.style.display = 'block';
  stopBtn.style.display = 'inline-block';

  if (quaggaStarted) {
    Quagga.stop();
    quaggaStarted = false;
  }

  // Reset scan attempts
  scanAttempts = 0;

  // Add timeout to prevent stuck state
  const timeoutId = setTimeout(() => {
    if (!quaggaStarted) {
      console.error("Scanner initialization timeout");
      showNotification('Scanner initialization timed out. Please try again.', 'error', 4000);
      resetScannerUI();
    }
  }, 15000); // 15 second timeout

  // Check camera permission first on mobile
  if (isMobile) {
    checkCameraPermission().then(hasPermission => {
      if (!hasPermission) {
        console.error("Camera permission denied");
        showNotification('Camera access denied. Please allow camera permissions in your browser settings.', 'error', 5000);
        resetScannerUI();
        clearTimeout(timeoutId);
        return;
      }
      initializeQuagga();
    }).catch(error => {
      console.error("Camera check failed:", error);
      initializeQuagga(); // Try anyway
    });
  } else {
    initializeQuagga();
  }

  function initializeQuagga() {
    getCameraConstraints().then(constraints => {
      Quagga.init({
        inputStream: {
          name: "Live",
          type: "LiveStream",
          target: scannerDiv,
          constraints: constraints
        },
        locator: {
          patchSize: "large", // Better for mobile focus
          halfSample: false,  // Full resolution for better detection
        },
        numOfWorkers: isMobile ? 1 : 2,
        frequency: 15, // Higher frequency for better detection
        decoder: {
          readers: [
            "ean_reader",
            "code_128_reader",
            "code_39_reader"
          ]
        },
        locate: true
      }, function(err) {
        clearTimeout(timeoutId); // Clear timeout on completion
        
        if (err) {
          console.error("QuaggaJS init error:", err);
          
          // Provide specific error messages
          let errorMessage = "Error starting scanner: ";
          if (err.name === 'NotAllowedError') {
            errorMessage += "Camera access denied. Please allow camera permissions.";
          } else if (err.name === 'NotFoundError') {
            errorMessage += "No camera found on this device.";
          } else if (err.name === 'NotReadableError') {
            errorMessage += "Camera is already in use by another application.";
          } else if (err.name === 'NotSupportedError') {
            errorMessage += "Camera not supported on this device.";
          } else {
            errorMessage += err.message;
          }
          
          console.error(errorMessage);
          showNotification(errorMessage, 'error', 5000);
          resetScannerUI();
          return;
        }
        
        console.log("QuaggaJS initialized successfully");
        
        Quagga.start();
        quaggaStarted = true;
        
        // Reset button state
        startBtn.disabled = false;
        startBtn.textContent = 'üì∑ Scan Barcode';
        
        // Show success notification
        showNotification('Scanner ready!', 'success', 2000);
      });
    }).catch(error => {
      console.error("Error getting camera constraints:", error);
      showNotification('Error accessing camera', 'error', 4000);
      resetScannerUI();
    });
  }

  function resetScannerUI() {
    scannerDiv.style.display = 'none';
    stopBtn.style.display = 'none';
    startBtn.disabled = false;
    startBtn.textContent = 'üì∑ Scan Barcode';
  }

  Quagga.offDetected();
  
  Quagga.onDetected(function(result) {
    const now = Date.now();
    
    if (now - lastScanTime < SCAN_COOLDOWN) {
      return;
    }
    
    if (result && result.codeResult && result.codeResult.code) {
      const code = result.codeResult.code;
      const format = result.codeResult.format;
      console.log("Detected code:", code, "Format:", format);
      
      // Skip only the most problematic non-ISBN formats
      const skipFormats = ['ean_8', 'upc_e', 'i2of5'];
      if (skipFormats.includes(format)) {
        console.log("Skipping non-ISBN format:", format, code);
        return;
      }
      
      scanAttempts++;
      
      if (isValidISBNCode(code, format)) {
        console.log("Valid ISBN detected:", code);
        document.getElementById('isbn').value = code;
        stopScanner();
        lastScanTime = now;
        
        // Show success notification
        showNotification(`ISBN detected: ${code}`, 'success', 2000);
        
        // Auto-fetch the book data
        setTimeout(() => {
          document.querySelector('button[name="fetch"]').click();
        }, 500);
      } else {
        console.log("Invalid ISBN format:", code, format);
        
        // Stop after too many invalid attempts
        if (scanAttempts >= MAX_SCAN_ATTEMPTS) {
          stopScanner();
        }
      }
    }
  });
}

function stopScanner() {
  const scannerDiv = document.getElementById('scanner');
  const stopBtn = document.getElementById('stopBtn');
  
  if (quaggaStarted) {
    Quagga.stop();
    quaggaStarted = false;
  }
  
  scannerDiv.style.display = 'none';
  stopBtn.style.display = 'none';
  Quagga.offDetected();
}

// Add mobile-specific optimizations
function setupMobileOptimizations() {
  if (isMobile) {
    console.log("Mobile device detected:", navigator.userAgent);
    
    // Check if getUserMedia is supported
    if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
      console.error("getUserMedia not supported on this device");
      showNotification('Camera not supported on this device/browser', 'error', 5000);
    }
    
    // Prevent zoom on input focus
    const inputs = document.querySelectorAll('input[type="text"], input[type="date"]');
    inputs.forEach(input => {
      input.addEventListener('focus', function() {
        this.style.fontSize = '16px'; // Prevents zoom on iOS
      });
    });
    
    // Add touch-friendly button sizing
    const buttons = document.querySelectorAll('.btn-scan, .btn-stop, .btn-fetch');
    buttons.forEach(button => {
      button.style.minHeight = '44px'; // iOS minimum touch target
      button.style.minWidth = '44px';
    });
  }
}

// Initialize mobile optimizations
document.addEventListener('DOMContentLoaded', setupMobileOptimizations);

window.addEventListener('beforeunload', stopScanner);

// Add keyboard shortcuts
document.addEventListener('keydown', function(e) {
  if (e.key === 'Escape' && quaggaStarted) {
    stopScanner();
  }
});
</script>
{% endblock %}