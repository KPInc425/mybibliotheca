{% extends "base.html" %}
{% block title %}Test Native Barcode Scanner - MyBibliotheca{% endblock %}
{% block content %}

<style>
  .test-container {
    max-width: 600px;
    margin: 0 auto;
    padding: 20px;
    background: white;
    border-radius: 10px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
  }
  
  .test-header {
    text-align: center;
    margin-bottom: 30px;
  }
  
  .test-button {
    display: block;
    width: 100%;
    padding: 15px;
    margin: 10px 0;
    background: #007bff;
    color: white;
    border: none;
    border-radius: 8px;
    font-size: 16px;
    cursor: pointer;
    text-align: center;
  }
  
  .test-button:hover {
    background: #0056b3;
  }
  
  .test-button:disabled {
    background: #6c757d;
    cursor: not-allowed;
  }
  
  .result {
    margin: 20px 0;
    padding: 15px;
    border-radius: 8px;
    font-family: monospace;
    white-space: pre-wrap;
  }
  
  .result.success {
    background: #d4edda;
    color: #155724;
    border: 1px solid #c3e6cb;
  }
  
  .result.error {
    background: #f8d7da;
    color: #721c24;
    border: 1px solid #f5c6cb;
  }
  
  .result.info {
    background: #d1ecf1;
    color: #0c5460;
    border: 1px solid #bee5eb;
  }
  
  .status {
    text-align: center;
    font-weight: bold;
    margin: 10px 0;
  }
  
  .back-link {
    display: block;
    text-align: center;
    margin-top: 20px;
    color: #007bff;
    text-decoration: none;
  }
  
  .back-link:hover {
    text-decoration: underline;
  }
  
  /* Modal Dialog Styles */
  .modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.5);
    display: none;
    z-index: 1000;
    align-items: center;
    justify-content: center;
    pointer-events: auto;
  }
  
  .modal-dialog {
    background: white;
    border-radius: 12px;
    padding: 25px;
    max-width: 400px;
    width: 90%;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
    text-align: center;
    position: relative;
    z-index: 1001;
    pointer-events: auto;
  }
  
  .modal-title {
    font-size: 20px;
    font-weight: bold;
    margin-bottom: 15px;
    color: #333;
  }
  
  .modal-content {
    margin-bottom: 20px;
    line-height: 1.5;
    color: #666;
  }
  
  .modal-buttons {
    display: flex;
    gap: 10px;
    justify-content: center;
  }
  
  .modal-button {
    padding: 12px 20px;
    border: none;
    border-radius: 8px;
    font-size: 14px;
    font-weight: 500;
    cursor: pointer;
    flex: 1;
    max-width: 150px;
  }
  
  .modal-button.primary {
    background: #17a2b8;
    color: white;
  }
  
  .modal-button.secondary {
    background: #6c757d;
    color: white;
  }
  
  .modal-button:hover {
    opacity: 0.9;
  }
  
  .modal-path {
    font-size: 12px;
    color: #999;
    margin-top: 15px;
    padding: 10px;
    background: #f8f9fa;
    border-radius: 6px;
    border-left: 3px solid #17a2b8;
  }
</style>

<div class="test-container">
  <div class="test-header">
    <h1>üß™ Test Native Barcode Scanner</h1>
    <p>This page tests the MLKit native barcode scanner plugin</p>
  </div>
  
  <div id="status" class="status">Ready to test native barcode scanner</div>
  
  <button id="testNativeScanner" class="test-button">
    üì± Launch Native Barcode Scanner
  </button>
  
  <button id="debugPlugins" class="test-button" style="background: #6c757d;">
    üîç Debug Plugin Availability
  </button>
  
  <button id="testPermissions" class="test-button" style="background: #28a745;">
    üì∑ Test Camera Permissions
  </button>
  
  <button id="testBrowserScanner" class="test-button">
    üåê Test Browser Barcode Scanner (Fallback)
  </button>
  
  <div id="result" class="result info" style="display: none;"></div>
  
  <div id="logs" style="margin-top: 20px; font-family: monospace; font-size: 12px; max-height: 200px; overflow-y: auto; background: #f8f9fa; padding: 10px; border-radius: 5px;"></div>
  
  <a href="{{ url_for('main.index') }}" class="back-link">‚¨ÖÔ∏è Back to Library</a>
</div>

<!-- Permission Modal Dialog -->
<div id="permissionModal" class="modal-overlay">
  <div class="modal-dialog">
    <div class="modal-title">üì± Camera Permissions Required</div>
    <div class="modal-content">
      <p>The barcode scanner needs camera access to work.</p>
      <p>Would you like to open your device settings to enable camera permissions?</p>
    </div>
    <div class="modal-buttons">
      <button id="confirmOpenSettings" class="modal-button primary">
        ‚úÖ Yes, Open Settings
      </button>
      <button id="cancelSettings" class="modal-button secondary">
        ‚ùå Cancel
      </button>
    </div>
    <div class="modal-path">
      <strong>Manual path:</strong><br>
      Settings ‚Üí Apps ‚Üí MyBibliotheca ‚Üí Permissions ‚Üí Enable Camera
    </div>
    <button id="closeModal" class="modal-button secondary" style="margin-top: 15px; width: 100%;">
      ‚úñÔ∏è Close Modal
    </button>
  </div>
</div>

<script>
  // Check if we're running in a Capacitor environment
  const isCapacitor = typeof Capacitor !== 'undefined';
  const isNative = isCapacitor && Capacitor.isNative;
  
  function log(message, type = 'info') {
    const logsDiv = document.getElementById('logs');
    const timestamp = new Date().toLocaleTimeString();
    const logEntry = document.createElement('div');
    logEntry.style.color = type === 'error' ? '#dc3545' : type === 'success' ? '#28a745' : '#007bff';
    logEntry.textContent = `[${timestamp}] ${message}`;
    logsDiv.appendChild(logEntry);
    logsDiv.scrollTop = logsDiv.scrollHeight;
    console.log(message);
  }
  
  function updateStatus(message, type = 'info') {
    const statusDiv = document.getElementById('status');
    statusDiv.textContent = message;
    statusDiv.className = `status ${type}`;
  }
  
  function showResult(message, type = 'info') {
    const resultDiv = document.getElementById('result');
    resultDiv.textContent = message;
    resultDiv.className = `result ${type}`;
    resultDiv.style.display = 'block';
  }
  
  function showPermissionHelp() {
    const modal = document.getElementById('permissionModal');
    modal.style.display = 'flex';
  }
  
  function hidePermissionHelp() {
    const modal = document.getElementById('permissionModal');
    modal.style.display = 'none';
  }
  
  function openDeviceSettings() {
    try {
      log('Attempting to open device settings...');
      
      if (isCapacitor && Capacitor.Plugins.NativeSettings) {
        // Use the native settings plugin
        log('Using capacitor-native-settings plugin...');
        try {
          Capacitor.Plugins.NativeSettings.open({
            option: 'application'
          }).then(() => {
            log('NativeSettings.open() completed successfully');
          }).catch((error) => {
            log(`NativeSettings.open() failed: ${error.message}`, 'error');
            // Try fallback
            tryFallbackSettings();
          });
        } catch (error) {
          log(`NativeSettings.open() threw error: ${error.message}`, 'error');
          tryFallbackSettings();
        }
      } else {
        tryFallbackSettings();
      }
    } catch (error) {
      log(`Error in openDeviceSettings: ${error.message}`, 'error');
      alert('Please manually go to your device settings ‚Üí Apps ‚Üí MyBibliotheca ‚Üí Permissions ‚Üí Enable Camera');
    }
  }
  
  function tryFallbackSettings() {
    log('Trying fallback settings methods...');
    
    if (isCapacitor && Capacitor.Plugins.App) {
      // Fallback to Capacitor App plugin
      log('Using Capacitor App plugin as fallback...');
      try {
        Capacitor.Plugins.App.openSettings();
        log('App.openSettings() called');
      } catch (error) {
        log(`App.openSettings() failed: ${error.message}`, 'error');
        tryAndroidDeepLink();
      }
    } else {
      tryAndroidDeepLink();
    }
  }
  
  function tryAndroidDeepLink() {
    if (navigator.userAgent.includes('Android')) {
      // Fallback to Android deep link
      const packageName = 'com.ilgaming.mybibliotheca';
      const settingsUrl = `android-app://com.android.settings/.applications.InstalledAppDetails?pkg=${packageName}`;
      
      log(`Using Android deep link: ${settingsUrl}`);
      try {
        window.location.href = settingsUrl;
        log('Android deep link attempted');
      } catch (error) {
        log(`Android deep link failed: ${error.message}`, 'error');
        showManualInstructions();
      }
    } else {
      showManualInstructions();
    }
  }
  
  function showManualInstructions() {
    log('All automatic methods failed, showing manual instructions');
    alert('Please go to your device settings ‚Üí Apps ‚Üí MyBibliotheca ‚Üí Permissions ‚Üí Enable Camera');
  }
  
  // Initialize
  document.addEventListener('DOMContentLoaded', function() {
    log('Test page loaded');
    log(`Capacitor available: ${isCapacitor}`);
    log(`Native platform: ${isNative}`);
    
    if (isCapacitor) {
      log('Capacitor detected - native scanner should be available');
      
      // Log Capacitor object structure
      log('Capacitor object keys:');
      Object.keys(Capacitor).forEach(key => {
        log(`  - ${key}: ${typeof Capacitor[key]}`);
      });
      
      // Check what plugins are available
      if (Capacitor.Plugins) {
        log('Available plugins:');
        Object.keys(Capacitor.Plugins).forEach(plugin => {
          log(`  - ${plugin}`);
        });
      }
      
      updateStatus('Native scanner ready', 'success');
    } else {
      log('Running in browser - will use fallback scanner');
      updateStatus('Browser mode - using fallback scanner', 'info');
    }
    
    // Add click outside modal to close
    document.getElementById('permissionModal').addEventListener('click', function(e) {
      if (e.target === this) {
        hidePermissionHelp();
      }
    });
    
    // Add modal button event listeners
    document.getElementById('confirmOpenSettings').addEventListener('click', function() {
      log('User confirmed opening device settings');
      openDeviceSettings();
      // Don't close modal immediately - let the user see the logs
      // hidePermissionHelp();
    });
    
    document.getElementById('cancelSettings').addEventListener('click', function() {
      log('User cancelled opening device settings');
      hidePermissionHelp();
      showResult('Camera permissions are required to use the barcode scanner.', 'info');
    });
    
    document.getElementById('closeModal').addEventListener('click', function() {
      log('User closed modal manually');
      hidePermissionHelp();
    });
  });
  
  // Test Native Scanner
  document.getElementById('testNativeScanner').addEventListener('click', async function() {
    const button = this;
    button.disabled = true;
    button.textContent = 'üîÑ Launching...';
    
    try {
      if (!isCapacitor) {
        throw new Error('Capacitor not available - cannot use native scanner');
      }
      
      log('Attempting to launch native barcode scanner...');
      updateStatus('Launching native scanner...', 'info');
      
      // Get the BarcodeScanner plugin from Capacitor.Plugins
      const BarcodeScanner = Capacitor.Plugins.BarcodeScanner;
      if (!BarcodeScanner) {
        throw new Error('BarcodeScanner plugin not found in Capacitor.Plugins');
      }
      
      log('Found BarcodeScanner plugin in Capacitor.Plugins');
      
      // Check if scanning is supported
      const { supported } = await BarcodeScanner.isSupported();
      if (!supported) {
        throw new Error('Barcode scanning not supported on this device');
      }
      
      log('Barcode scanning is supported');
      
      // Check permissions
      log('Checking camera permissions...');
      const { granted } = await BarcodeScanner.checkPermissions();
      log(`Initial permission status: ${granted ? 'granted' : 'denied'}`);
      
      if (!granted) {
        log('Requesting camera permissions...');
        try {
          const { granted: newGranted } = await BarcodeScanner.requestPermissions();
          log(`Permission request result: ${newGranted ? 'granted' : 'denied'}`);
          if (!newGranted) {
            throw new Error('Camera permission denied by user');
          }
        } catch (permissionError) {
          log(`Permission request error: ${permissionError.message}`, 'error');
          showResult(`Camera permission error: ${permissionError.message}`, 'error');
          showPermissionHelp();
          return;
        }
      }
      
      log('Camera permissions granted');
      
      // Start scanning
      log('Starting barcode scan...');
      const { barcodes } = await BarcodeScanner.scan();
      
      if (barcodes && barcodes.length > 0) {
        const barcode = barcodes[0];
        const result = `‚úÖ Barcode Detected!
Format: ${barcode.format}
Value: ${barcode.rawValue}
Type: ${barcode.type}
Confidence: ${barcode.confidence || 'N/A'}`;
        
        log(`Native scanner detected: ${barcode.rawValue} (${barcode.format})`, 'success');
        showResult(result, 'success');
        updateStatus(`Detected: ${barcode.rawValue}`, 'success');
      } else {
        log('No barcode detected');
        showResult('No barcode detected', 'info');
        updateStatus('No barcode detected', 'info');
      }
      
    } catch (error) {
      log(`Native scanner error: ${error.message}`, 'error');
      showResult(`Error: ${error.message}`, 'error');
      updateStatus('Native scanner failed', 'error');
    } finally {
      button.disabled = false;
      button.textContent = 'üì± Launch Native Barcode Scanner';
    }
  });
  
  // Debug Plugin Availability
  document.getElementById('debugPlugins').addEventListener('click', function() {
    const button = this;
    button.disabled = true;
    button.textContent = 'üîç Debugging...';
    
    try {
      log('=== DEBUGGING PLUGIN AVAILABILITY ===');
      
      if (!isCapacitor) {
        log('‚ùå Capacitor not available', 'error');
        showResult('Capacitor not available in this environment', 'error');
        return;
      }
      
      log('‚úÖ Capacitor is available');
      
      // Log Capacitor object structure
      log('Capacitor object structure:');
      Object.keys(Capacitor).forEach(key => {
        log(`