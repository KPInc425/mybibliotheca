{% extends "base.html" %}

{% block title %}Add Book - BookOracle{% endblock %}

{% block content %}
<div class="hero bg-gradient-to-br from-primary to-secondary text-primary-content py-12 rounded-box mb-8">
  <div class="hero-content text-center">
    <div>
      <h1 class="text-5xl font-bold mb-4">üìö Add New Book</h1>
      <p class="text-xl opacity-90">Scan, search, or manually add books to your library</p>
    </div>
  </div>
</div>

<div class="card bg-base-100 shadow-xl">
  <div class="card-body">
    <form method="post" class="space-y-6">
      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
      
      <!-- Scanner Section -->
      <div class="card bg-base-200 border-2 border-primary/20">
        <div class="card-body">
          <h3 class="card-title text-primary mb-4">
            üì± Barcode Scanner
          </h3>
          
          <!-- Scanner Tips -->
          <div class="alert alert-info mb-4">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" class="stroke-current shrink-0 w-6 h-6">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
            <div>
              <h4 class="font-bold">Scanner Tips</h4>
              <div class="text-sm">
                <p><strong>Native App:</strong> Best experience with automatic scanning</p>
                <p><strong>Browser:</strong> Works but may be slower on mobile devices</p>
                <p><strong>Manual Mode:</strong> Use camera to view barcode, then enter ISBN manually</p>
              </div>
            </div>
          </div>
          
          <!-- Scanner Button -->
          <div class="flex justify-center mb-4">
            <button type="button" class="btn btn-primary btn-lg" onclick="handleScannerButtonClick()" id="scannerBtn">
              üì∑ Scan Barcode
            </button>
          </div>
          
          <!-- Debug Button (only show in development) -->
          {% if config.DEBUG_MODE or current_user.debug_enabled %}
          <div class="flex justify-center mb-4 gap-2">
            <button type="button" class="btn btn-outline btn-info btn-sm" onclick="debugScanner()" id="debugBtn">
              üîç Debug Scanner
            </button>
            <button type="button" class="btn btn-outline btn-warning btn-sm" onclick="testNativeScanner()" id="testNativeBtn">
              üì± Test Native Scanner
            </button>
            <button type="button" class="btn btn-outline btn-success btn-sm" onclick="requestPermissions()" id="requestPermBtn">
              üîê Request Permissions
            </button>
            <button type="button" class="btn btn-outline btn-error btn-sm" onclick="testScannerWithPermissionBypass()" id="testBypassBtn">
              üöÄ Test with Bypass
            </button>
          </div>
          {% endif %}
          
          <!-- Scanner Viewport -->
          <div id="scanner" class="hidden w-full max-w-md h-80 mx-auto relative bg-black rounded-box overflow-hidden">
            <video id="scanner-video" class="w-full h-full object-cover rounded-box" autoplay playsinline muted></video>
            <div id="scanner-overlay" class="scanner-overlay absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 w-48 h-48 rounded-box pointer-events-none"></div>
          </div>
          
          <!-- Scanner Status -->
          <div id="scannerStatus" class="hidden mt-4"></div>
        </div>
      </div>

      <!-- ISBN and Fetch Section -->
      <div class="form-control">
        <label class="label">
          <span class="label-text text-lg font-semibold">üìñ ISBN Number</span>
        </label>
        <div class="join w-full">
          <input id="isbn" name="isbn" class="input input-bordered join-item flex-1" 
                 value="{{ request.form.isbn or '' }}" 
                 type="text" pattern="[0-9\-]+" title="Enter a valid ISBN (digits and hyphens only)"
                 placeholder="Enter ISBN or scan barcode above">
          <button id="fetchBtn" name="fetch" value="1" type="button" class="btn btn-secondary join-item">
            üîç Fetch Book Data
          </button>
        </div>
      </div>

      <!-- Book Details -->
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <div class="form-control">
          <label class="label">
            <span class="label-text text-lg font-semibold">üìö Title</span>
          </label>
          <input id="title" name="title" class="input input-bordered" 
                 value="{{ book_data.title if book_data else request.form.title or '' }}"
                 placeholder="Enter book title">
        </div>
        
        <div class="form-control">
          <label class="label">
            <span class="label-text text-lg font-semibold">‚úçÔ∏è Author</span>
          </label>
          <input id="author" name="author" class="input input-bordered" 
                 value="{{ book_data.author if book_data else request.form.author or '' }}"
                 placeholder="Enter author name">
        </div>
        
        <div class="form-control">
          <label class="label">
            <span class="label-text text-lg font-semibold">üè¢ Publisher</span>
          </label>
          <input id="publisher" name="publisher" class="input input-bordered" 
                 value="{{ book_data.publisher if book_data else request.form.publisher or '' }}"
                 placeholder="Enter publisher name">
        </div>
        
        <div class="form-control">
          <label class="label">
            <span class="label-text text-lg font-semibold">üìÖ Publication Date</span>
          </label>
          <input id="publication_date" name="publication_date" class="input input-bordered" 
                 value="{{ book_data.published_date if book_data else request.form.publication_date or '' }}"
                 placeholder="Enter publication date">
        </div>
        
        <div class="form-control">
          <label class="label">
            <span class="label-text text-lg font-semibold">üìÑ Pages</span>
          </label>
          <input id="pages" name="pages" class="input input-bordered" 
                 value="{{ book_data.page_count if book_data else request.form.pages or '' }}"
                 placeholder="Enter number of pages">
        </div>
        
        <div class="form-control">
          <label class="label">
            <span class="label-text text-lg font-semibold">üåê Language</span>
          </label>
          <input id="language" name="language" class="input input-bordered" 
                 value="{{ book_data.language if book_data else request.form.language or '' }}"
                 placeholder="Enter language">
        </div>
        
        <div class="form-control">
          <label class="label">
            <span class="label-text text-lg font-semibold">üì¶ Format</span>
          </label>
          <input id="format" name="format" class="input input-bordered" 
                 value="{{ book_data.format if book_data else request.form.format or '' }}"
                 placeholder="Enter format (optional)">
        </div>
        
        <div class="form-control">
          <label class="label">
            <span class="label-text text-lg font-semibold">üìù Description</span>
          </label>
          <textarea id="description" name="description" class="textarea textarea-bordered h-24"
                    placeholder="Enter book description">{{ book_data.description if book_data else request.form.description or '' }}</textarea>
        </div>
      </div>

      <!-- Book Cover Preview -->
      <div class="card bg-base-200">
        <div class="card-body text-center">
          <h3 class="card-title text-primary mb-4">üì∏ Book Cover</h3>
          <img id="coverPreviewImg" 
               src="{{ book_data.cover if book_data and book_data.cover else url_for('static', filename='bookshelf.png') }}" 
               alt="Book Cover" 
               class="max-h-56 rounded-box shadow-lg mx-auto">
        </div>
      </div>

      <!-- Reading Options -->
      <div class="card bg-base-200">
        <div class="card-body">
          <h3 class="card-title text-primary mb-4">‚öôÔ∏è Reading Options</h3>
          <div class="space-y-4">
            <label class="label cursor-pointer justify-start gap-4">
              <input type="checkbox" name="want_to_read" class="checkbox checkbox-primary" 
                     {% if request.form.want_to_read %}checked{% endif %}>
              <span class="label-text text-lg">üìã Want to Read (Add to reading list)</span>
            </label>
            <label class="label cursor-pointer justify-start gap-4">
              <input type="checkbox" name="library_only" class="checkbox checkbox-primary" 
                     {% if request.form.library_only %}checked{% endif %}>
              <span class="label-text text-lg">üìö Library Only (Reference/Collection)</span>
            </label>
          </div>
        </div>
      </div>

      <!-- Submit Button -->
      <div class="flex justify-center">
        <button type="submit" name="add" class="btn btn-primary btn-lg btn-wide">
          ‚ûï Add Book to Library
        </button>
      </div>
    </form>

    <!-- Back Link -->
    <div class="text-center mt-8">
      <a href="{{ url_for('main.index') }}" class="btn btn-outline btn-wide">
        ‚¨ÖÔ∏è Back to Library
      </a>
    </div>
  </div>
</div>

<!-- Early environment detection setup -->
<script>
// Set up environment detection before loading scanner modules
window.isCapacitor = typeof Capacitor !== 'undefined';
window.isNative = window.isCapacitor && Capacitor.isNative;

// Get the actual platform
window.platform = window.isCapacitor ? Capacitor.getPlatform() : 'web';

console.log('[Scanner] Environment detection:', {
  isCapacitor: window.isCapacitor,
  isNative: window.isNative,
  platform: window.platform,
  Capacitor: typeof Capacitor,
  CapacitorIsNative: window.isCapacitor ? Capacitor.isNative : 'N/A',
  CapacitorPlugins: window.isCapacitor ? Object.keys(Capacitor.Plugins || {}) : 'N/A'
});

// Check if native scanner is available
const nativeScannerAvailable = window.isCapacitor && 
                              window.platform !== 'web' && 
                              typeof Capacitor !== 'undefined' && 
                              Capacitor.Plugins && 
                              Capacitor.Plugins.BarcodeScanner;

console.log('[Scanner] Native scanner availability:', {
  nativeScannerAvailable,
  shouldLoadZXing: !nativeScannerAvailable
});

// Only load ZXing if native scanner is not available
if (!nativeScannerAvailable) {
  console.log('[Scanner] Native scanner not available, loading ZXing library...');
  
  // Dynamically load ZXing library
  const zxingScript = document.createElement('script');
  zxingScript.src = "{{ url_for('static', filename='node_modules/@zxing/browser/umd/index.min.js') }}";
  zxingScript.onload = function() {
    console.log('[Scanner] ZXing library loaded successfully');
    
    // Check if ZXing library loaded correctly
    console.log('[Scanner] ZXing library check:', {
      ZXingBrowser: typeof ZXingBrowser,
      BrowserMultiFormatReader: typeof ZXingBrowser !== 'undefined' ? typeof ZXingBrowser.BrowserMultiFormatReader : 'N/A'
    });
    
    if (typeof ZXingBrowser === 'undefined') {
      console.error('[Scanner] ZXing library failed to load!');
    }
    
    // Load ZXing scanner module after library is loaded
    const zxingModuleScript = document.createElement('script');
    zxingModuleScript.src = "{{ url_for('static', filename='scanner-zxing.js') }}";
    zxingModuleScript.onload = function() {
      console.log('[Scanner] ZXing scanner module loaded');
    };
    document.head.appendChild(zxingModuleScript);
  };
  zxingScript.onerror = function() {
    console.error('[Scanner] Failed to load ZXing library');
  };
  document.head.appendChild(zxingScript);
} else {
  console.log('[Scanner] Native scanner available, skipping ZXing library load');
}
</script>

<!-- Load modular scanner scripts (always load core modules) -->
<script src="{{ url_for('static', filename='scanner-utils.js') }}"></script>
<script src="{{ url_for('static', filename='scanner-native.js') }}"></script>
<script src="{{ url_for('static', filename='scanner-core.js') }}"></script>
<!-- ZXing scanner module is loaded conditionally above -->
<script src="{{ url_for('static', filename='scanner-ui.js') }}"></script>
<script src="{{ url_for('static', filename='scanner-data.js') }}"></script>
<script src="{{ url_for('static', filename='scanner.js') }}"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
  console.log('[AddBook] DOM loaded, initializing scanner...');
  
  // Initialize mobile optimizations if available
  if (typeof setupMobileOptimizations === 'function') {
    console.log('[AddBook] Setting up mobile optimizations...');
    setupMobileOptimizations();
  }
  
  // Initialize scanner functions
  if (typeof importModuleFunctions === 'function') {
    console.log('[AddBook] Importing module functions...');
    importModuleFunctions();
  }
  
  // Check scanner system status
  if (typeof getScannerSystemStatus === 'function') {
    const status = getScannerSystemStatus();
    console.log('[AddBook] Scanner system status:', status);
  }
  
  console.log('[AddBook] Scanner initialization complete');
});

// Debug function for scanner issues
async function debugScanner() {
  console.log('[Debug] Starting scanner debug...');
  
  const debugInfo = {
    environment: {
      isCapacitor: window.isCapacitor,
      isNative: window.isNative,
      platform: window.platform,
      Capacitor: typeof Capacitor,
      CapacitorIsNative: window.isCapacitor ? Capacitor.isNative : 'N/A',
      CapacitorPlugins: window.isCapacitor ? Object.keys(Capacitor.Plugins || {}) : 'N/A'
    },
    modules: {
      ScannerCore: !!window.ScannerCore,
      NativeScanner: !!window.NativeScanner,
      ScannerZXing: !!window.ScannerZXing,
      ScannerUI: !!window.ScannerUI,
      ScannerData: !!window.ScannerData
    },
    functions: {
      handleScannerButtonClick: typeof handleScannerButtonClick,
      startSmartScanner: typeof startSmartScanner,
      startNativeScanner: typeof startNativeScanner,
      startBrowserScanner: typeof startBrowserScanner
    }
  };
  
  console.log('[Debug] Scanner debug info:', debugInfo);
  
  // Test native scanner if available
  if (window.NativeScanner && window.NativeScanner.debugNativeScanner) {
    try {
      const nativeResult = await window.NativeScanner.debugNativeScanner();
      console.log('[Debug] Native scanner debug result:', nativeResult);
      debugInfo.nativeScannerDebug = nativeResult;
    } catch (error) {
      console.log('[Debug] Native scanner debug error:', error);
      debugInfo.nativeScannerError = error.message;
    }
  }
  
  // Test ZXing scanner if available
  if (window.ScannerZXing && window.ScannerZXing.debugZXingScanner) {
    try {
      const zxingResult = window.ScannerZXing.debugZXingScanner();
      console.log('[Debug] ZXing scanner debug result:', zxingResult);
      debugInfo.zxingScannerDebug = zxingResult;
    } catch (error) {
      console.log('[Debug] ZXing scanner debug error:', error);
      debugInfo.zxingScannerError = error.message;
    }
  }
  
  // Test scanner availability
  if (window.ScannerCore && window.ScannerCore.isScannerAvailable) {
    const available = window.ScannerCore.isScannerAvailable();
    console.log('[Debug] Scanner available:', available);
    debugInfo.scannerAvailable = available;
  }
  
  // Add note about Android permission check issue
  debugInfo.notes = {
    androidPermissionCheck: "On Android, permission checks may show 'denied' even when permissions are granted for 'only when using app'. If the scanner works, permissions are actually granted.",
    zxingLibrary: "ZXing library is not loaded (ZXingBrowser is undefined), but this is expected since native scanner is working."
  };
  
  // Create a modal with the debug info that can be copied
  const debugText = JSON.stringify(debugInfo, null, 2);
  
  // Create modal HTML
  const modalHTML = `
    <div id="debugModal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; display: flex; align-items: center; justify-content: center;">
      <div style="background: white; padding: 20px; border-radius: 10px; max-width: 90%; max-height: 90%; overflow: auto;">
        <h3>Scanner Debug Information</h3>
        <textarea id="debugTextArea" style="width: 100%; height: 400px; font-family: monospace; font-size: 12px; margin: 10px 0;" readonly>${debugText}</textarea>
        <div style="text-align: center; margin-top: 10px;">
          <button onclick="copyDebugInfo()" style="margin: 5px; padding: 10px 20px; background: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer;">üìã Copy to Clipboard</button>
          <button onclick="closeDebugModal()" style="margin: 5px; padding: 10px 20px; background: #6c757d; color: white; border: none; border-radius: 5px; cursor: pointer;">‚ùå Close</button>
        </div>
      </div>
    </div>
  `;
  
  // Add modal to page
  document.body.insertAdjacentHTML('beforeend', modalHTML);
}

// Copy debug info to clipboard
function copyDebugInfo() {
  const textArea = document.getElementById('debugTextArea');
  textArea.select();
  document.execCommand('copy');
  alert('Debug information copied to clipboard!');
}

// Close debug modal
function closeDebugModal() {
  const modal = document.getElementById('debugModal');
  if (modal) {
    modal.remove();
  }
}

// Direct test of native scanner
async function testNativeScanner() {
  console.log('[Debug] Testing native scanner directly...');
  
  if (!window.isCapacitor) {
    alert('Capacitor not available - cannot test native scanner');
    return;
  }
  
  if (!Capacitor.Plugins.BarcodeScanner) {
    alert('BarcodeScanner plugin not found - cannot test native scanner');
    return;
  }
  
  try {
    console.log('[Debug] Starting native scanner test...');
    const BarcodeScanner = Capacitor.Plugins.BarcodeScanner;
    
    // Check if scanning is supported
    const { supported } = await BarcodeScanner.isSupported();
    console.log('[Debug] Barcode scanning supported:', supported);
    
    if (!supported) {
      alert('Barcode scanning not supported on this device');
      return;
    }
    
    // Try to start scanning
    console.log('[Debug] Attempting to start barcode scan...');
    const { barcodes } = await BarcodeScanner.scan();
    
    if (barcodes && barcodes.length > 0) {
      const barcode = barcodes[0];
      const result = `‚úÖ Native Scanner Test Successful!
Format: ${barcode.format}
Value: ${barcode.rawValue}
Type: ${barcode.type}
Confidence: ${barcode.confidence || 'N/A'}`;
      
      console.log('[Debug] Native scanner test successful:', barcode);
      alert(result);
    } else {
      console.log('[Debug] No barcode detected in test');
      alert('No barcode detected during test');
    }
    
  } catch (error) {
    console.error('[Debug] Native scanner test failed:', error);
    alert(`Native scanner test failed: ${error.message}`);
  }
}

// Request camera permissions
async function requestPermissions() {
  console.log('[Debug] Requesting camera permissions...');
  
  if (!window.isCapacitor) {
    alert('Capacitor not available - cannot request permissions');
    return;
  }
  
  if (!Capacitor.Plugins.BarcodeScanner) {
    alert('BarcodeScanner plugin not found - cannot request permissions');
    return;
  }
  
  try {
    console.log('[Debug] Starting permission request...');
    const BarcodeScanner = Capacitor.Plugins.BarcodeScanner;
    
    // Check if scanning is supported
    const { supported } = await BarcodeScanner.isSupported();
    console.log('[Debug] Barcode scanning supported:', supported);
    
    if (!supported) {
      alert('Barcode scanning not supported on this device');
      return;
    }
    
    // Check current permissions first
    console.log('[Debug] Checking current permissions...');
    let currentGranted = false;
    try {
      const { granted } = await BarcodeScanner.checkPermissions();
      currentGranted = granted;
      console.log(`[Debug] Current permission status: ${granted ? 'GRANTED' : 'DENIED'}`);
    } catch (error) {
      console.log('[Debug] Error checking current permissions:', error);
    }
    
    if (currentGranted) {
      alert('‚úÖ Camera permissions are already granted! The scanner should work.');
      return;
    } else {
      // Note: On Android, permission checks can be inaccurate due to "only when using app" settings
      console.log('[Debug] Permissions appear denied, but this might be inaccurate on Android');
    }
    
    // Request permissions directly
    console.log('[Debug] Requesting camera permissions...');
    const { granted } = await BarcodeScanner.requestPermissions();
    console.log(`[Debug] Permission request result: ${granted ? 'GRANTED' : 'DENIED'}`);
    
    if (granted) {
      console.log('[Debug] Camera permissions granted successfully!');
      alert('‚úÖ Camera permissions granted successfully! You can now use the barcode scanner.');
    } else {
      console.log('[Debug] Camera permissions denied');
      alert('‚ùå Camera permissions were denied.\n\nNote: On Android, permission checks can be inaccurate. If the scanner works, permissions are actually granted.\n\nTo ensure permissions are set correctly:\n1. Go to Settings > Apps > BookOracle > Permissions\n2. Enable Camera permission\n3. Make sure it\'s set to "Allow while using app" or "Allow all the time"');
    }
  } catch (error) {
    console.error('[Debug] Permission request error:', error);
    alert(`Permission request error: ${error.message}`);
  }
}

// Test scanner with permission bypass (for "only when using app" scenario)
async function testScannerWithPermissionBypass() {
  console.log('[Debug] Testing scanner with permission bypass...');
  
  if (!window.isCapacitor) {
    alert('Capacitor not available - cannot test scanner');
    return;
  }
  
  if (!Capacitor.Plugins.BarcodeScanner) {
    alert('BarcodeScanner plugin not found - cannot test scanner');
    return;
  }
  
  try {
    console.log('[Debug] Starting scanner test with permission bypass...');
    const BarcodeScanner = Capacitor.Plugins.BarcodeScanner;
    
    // Check if scanning is supported
    const { supported } = await BarcodeScanner.isSupported();
    console.log('[Debug] Barcode scanning supported:', supported);
    
    if (!supported) {
      alert('Barcode scanning not supported on this device');
      return;
    }
    
    // Check permissions but don't fail if denied
    let permissionGranted = false;
    try {
      const { granted } = await BarcodeScanner.checkPermissions();
      permissionGranted = granted;
      console.log(`[Debug] Permission status: ${granted ? 'GRANTED' : 'DENIED'}`);
    } catch (error) {
      console.log('[Debug] Error checking permissions:', error);
    }
    
    if (!permissionGranted) {
      console.log('[Debug] Permissions appear denied, but trying to scan anyway...');
      alert('Permissions appear denied, but trying to scan anyway (this handles "only when using app" scenario)...');
    }
    
    // Try to start scanning regardless of permission status
    console.log('[Debug] Attempting to start barcode scan...');
    const { barcodes } = await BarcodeScanner.scan();
    
    if (barcodes && barcodes.length > 0) {
      const barcode = barcodes[0];
      const result = `‚úÖ Scanner Test Successful (with permission bypass)!
Format: ${barcode.format}
Value: ${barcode.rawValue}
Type: ${barcode.type}
Confidence: ${barcode.confidence || 'N/A'}`;
      
      console.log('[Debug] Scanner test successful:', barcode);
      alert(result);
    } else {
      console.log('[Debug] No barcode detected in test');
      alert('No barcode detected during test');
    }
    
  } catch (error) {
    console.error('[Debug] Scanner test failed:', error);
    alert(`Scanner test failed: ${error.message}`);
  }
}
</script>
{% endblock %}
